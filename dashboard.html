<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Member Area - YLOS 2026</title>
    <link rel="icon" type="image/png" href="LOGO YLOS 5x5.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // Sembunyikan seluruh isi body sebelum dipastikan sesi ada
        document.documentElement.style.visibility = 'hidden';

        const supabaseUrl = 'https://jrslgkxwjvugvgakxwsd.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impyc2xna3h3anZ1Z3ZnYWt4d3NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTYyNDYsImV4cCI6MjA4NTM5MjI0Nn0.q2GGd0kdKt7KGWt7QpfeP0UUBOStmuUH51caPoCrmMk';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabaseClient.auth.getSession();
                
                if (error || !session) {
                    window.location.replace('index.html#login');
                    return;
                }

                // Jika ada sesi, tampilkan UI
                document.documentElement.style.visibility = '';

                // Fungsi perenderan
                const renderUI = () => {
                    const emailDisplay = document.getElementById('user-email-display');
                    if (emailDisplay) emailDisplay.innerText = session.user.email;
                    
                    // Pastikan fungsi dari body sudah bisa dipanggil
                    if (typeof loadDashboard === 'function') {
                        loadDashboard(session.user.id);
                        initTracking(session);
                    }
                };

                // FIX: Mencegah Race Condition DOMContentLoaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', renderUI);
                } else {
                    renderUI(); // Eksekusi langsung jika DOM sudah ter-load
                }
            } catch (err) {
                console.error("Auth check failed:", err);
                window.location.replace('index.html#login');
            }
        }
        checkAuth();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ylosPink: '#FF85B3',
                        ylosDarkPink: '#DB2777',
                        ylosYellow: '#FFD700',
                        ylosGreen: '#9ACD32',
                        ylosDark: '#111827',
                    },
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #FF85B3; }
        
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm {
            background-color: #FF85B3 !important; border-radius: 12px;
        }

        .prose { color: #374151; font-size: 0.95rem; line-height: 1.7; word-wrap: break-word; }
        .prose p { margin-bottom: 0.75em; }
        .prose img { max-width: 100%; height: auto; border-radius: 0.75rem; margin: 1rem 0; cursor: zoom-in; }
        .prose a { color: #DB2777; text-decoration: underline; font-weight: 600; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        
        /* Animasi Tab */
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        
        .nav-item.active { background-color: #fdf2f8; color: #DB2777; border-right: 4px solid #FF85B3; font-weight: 700; }
        .nav-item { border-right: 4px solid transparent; }
    </style>
</head>
<body class="font-sans text-gray-800 bg-gray-50 flex h-screen overflow-hidden selection:bg-ylosPink selection:text-white">

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-gray-900/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <aside id="sidebar" class="bg-white w-72 h-full border-r border-gray-200 flex flex-col fixed lg:relative z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 shadow-2xl lg:shadow-none">
        
        <div class="h-20 flex items-center gap-3 px-6 border-b border-gray-100 cursor-pointer" onclick="window.location.href='index.html'">
            <img src="LOGO YLOS 5x5.png" alt="Logo" class="h-10 w-auto object-contain">
            <div class="flex flex-col justify-center">
                <span class="font-extrabold text-xl tracking-tighter text-gray-900 leading-none">YLOS</span>
                <span class="text-[0.6rem] font-bold tracking-[0.2em] text-gray-400 uppercase">Dashboard</span>
            </div>
        </div>

        <div class="px-6 py-5 border-b border-gray-100 bg-gray-50/50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-ylosPink to-ylosYellow flex items-center justify-center text-white font-bold text-lg shadow-md">
                    <i class="fa-solid fa-user"></i>
                </div>
                <div class="overflow-hidden">
                    <p id="sidebar-user-name" class="font-bold text-gray-900 text-sm truncate">Loading...</p>
                    <p id="user-email-display" class="text-xs text-gray-500 truncate">user@email.com</p>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            <p class="px-6 text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Main Menu</p>
            <nav class="space-y-1">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-item active w-full flex items-center gap-3 px-6 py-3.5 text-gray-600 hover:bg-gray-50 transition text-left text-sm font-medium">
                    <i class="fa-solid fa-house w-5 text-center"></i> Beranda
                </button>
                <button onclick="switchTab('materi')" id="nav-materi" class="nav-item w-full flex items-center gap-3 px-6 py-3.5 text-gray-600 hover:bg-gray-50 transition text-left text-sm font-medium">
                    <i class="fa-solid fa-book-open w-5 text-center"></i> Modul & Materi
                </button>
                <button onclick="switchTab('video')" id="nav-video" class="nav-item w-full flex items-center justify-between px-6 py-3.5 text-gray-600 hover:bg-gray-50 transition text-left text-sm font-medium group">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-circle-play w-5 text-center group-hover:text-ylosPink transition"></i> Video Upskilling
                    </div>
                    <i class="fa-solid fa-lock text-gray-300 text-xs"></i>
                </button>
                <button onclick="switchTab('tugas')" id="nav-tugas" class="nav-item w-full flex items-center justify-between px-6 py-3.5 text-gray-600 hover:bg-gray-50 transition text-left text-sm font-medium group">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-medal w-5 text-center group-hover:text-ylosYellow transition"></i> Penugasan
                    </div>
                    <i class="fa-solid fa-lock text-gray-300 text-xs"></i>
                </button>
            </nav>

            <p class="px-6 text-xs font-bold text-gray-400 uppercase tracking-widest mt-8 mb-2">Akun</p>
            <nav class="space-y-1">
                <button onclick="switchTab('pengaturan')" id="nav-pengaturan" class="nav-item w-full flex items-center gap-3 px-6 py-3.5 text-gray-600 hover:bg-gray-50 transition text-left text-sm font-medium">
                    <i class="fa-solid fa-gear w-5 text-center"></i> Pengaturan
                </button>
                <button id="btn-admin-panel" onclick="window.location.href='admin.html'" class="hidden nav-item w-full flex items-center gap-3 px-6 py-3.5 text-purple-600 hover:bg-purple-50 transition text-left text-sm font-bold">
                    <i class="fa-solid fa-toolbox w-5 text-center"></i> Panel Admin
                </button>
            </nav>
        </div>

        <div class="p-4 border-t border-gray-100">
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 py-3 rounded-xl text-red-500 hover:bg-red-50 hover:text-red-600 transition font-bold text-sm">
                <i class="fa-solid fa-power-off"></i> Keluar Akun
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50/50">
        
        <header class="h-20 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-8 shrink-0 z-30">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden w-10 h-10 bg-gray-50 rounded-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 transition">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>
                <h1 id="header-title" class="text-xl font-bold text-gray-900">Beranda</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <span id="dash-status-badge" class="hidden md:inline-block px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-xs font-bold border border-gray-300">
                    Memuat Status...
                </span>
                <a href="index.html" class="text-sm font-bold text-gray-500 hover:text-ylosPink transition flex items-center gap-2">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i> <span class="hidden sm:inline">Web YLOS</span>
                </a>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 lg:p-8">
            
            <div id="tab-overview" class="tab-content active max-w-5xl mx-auto space-y-8">
                
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-3xl p-8 md:p-10 text-white shadow-xl relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="inline-block px-3 py-1 bg-white/10 rounded-full text-xs font-bold uppercase tracking-widest mb-3 backdrop-blur-sm border border-white/10">Member Area</div>
                        <h2 class="text-2xl md:text-4xl font-bold mb-2">Halo, <span id="dash-name" class="text-transparent bg-clip-text bg-gradient-to-r from-ylosPink to-ylosYellow">Leader!</span> ðŸ‘‹</h2>
                        <p class="opacity-80 text-sm md:text-base max-w-xl mt-2 leading-relaxed">Persiapkan dirimu untuk rangkaian seleksi YLOS 2026. Pantau status pembayaran dan pengumuman terbaru di halaman ini.</p>
                    </div>
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-ylosPink/20 to-transparent skew-x-12 transform translate-x-20"></div>
                    <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-ylosYellow/20 rounded-full blur-3xl"></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 hover:shadow-md transition duration-300">
                            <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2"><i class="fa-solid fa-wallet text-gray-400"></i> Status Pendaftaran</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-5 rounded-2xl border border-gray-100">
                                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-1">Paket Dipilih</p>
                                    <p id="dash-package" class="text-lg font-extrabold text-gray-900">Loading...</p>
                                </div>
                                
                                <div class="bg-gray-50 p-5 rounded-2xl border border-gray-100 flex justify-between items-center">
                                    <div>
                                        <p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest mb-1">Status</p>
                                        <span id="dash-status-text" class="text-sm font-bold text-gray-600">Loading...</span>
                                    </div>
                                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-gray-400 border border-gray-100">
                                        <i class="fa-solid fa-file-invoice"></i>
                                    </div>
                                </div>
                                
                                <div id="payment-actions">
                                    <button onclick="openLynkPayment()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-indigo-200 transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2 animate-pulse mt-2">
                                        ðŸ’³ Bayar & Finalisasi
                                    </button>
                                    <p class="text-center text-xs text-gray-400 mt-3 flex justify-center items-center gap-1"><i class="fa-solid fa-lock"></i> Secured by LYNK</p>
                                    <button onclick="contactAdmin()" class="w-full mt-3 border border-gray-200 text-gray-500 py-3 rounded-xl font-bold text-xs hover:bg-gray-50 hover:text-gray-700 transition">Butuh Bantuan?</button>
                                </div>
                                
                                <div id="wa-group-access" class="hidden space-y-3 pt-2">
                                    <button onclick="joinWaGroup()" class="w-full bg-[#25D366] hover:bg-[#128C7E] text-white py-4 rounded-2xl font-bold text-sm transition shadow-lg shadow-green-200 flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                                        <i class="fa-brands fa-whatsapp text-xl"></i> Gabung Grup WhatsApp
                                    </button>
                                    <p class="text-xs text-green-600 text-center font-bold bg-green-50 py-2 rounded-lg border border-green-100">Akses Eksklusif Member</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 min-h-full">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-500 text-lg"><i class="fa-solid fa-bullhorn"></i></div>
                                    <h3 class="text-xl font-bold text-gray-900">Papan Pengumuman</h3>
                                </div>
                            </div>
                            
                            <div id="announcement-content" class="space-y-4">
                                <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                                    <div class="w-12 h-12 border-4 border-gray-200 border-t-ylosPink rounded-full animate-spin mb-3"></div>
                                    <p class="text-sm font-medium">Memuat pengumuman...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-materi" class="tab-content max-w-5xl mx-auto">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100">
                    <div class="flex items-center gap-4 mb-8 pb-6 border-b border-gray-100">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white text-2xl shadow-lg shadow-blue-200">
                            <i class="fa-solid fa-book-open"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Modul & Materi Pembelajaran</h2>
                            <p class="text-sm text-gray-500 mt-1">Akses dokumen panduan, *twibbon*, dan materi *bootcamp* di sini.</p>
                        </div>
                    </div>

                    <div id="modules-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-400">
                            <div class="w-12 h-12 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin mb-3"></div>
                            <p class="text-sm font-medium">Memuat materi...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-video" class="tab-content max-w-5xl mx-auto h-[70vh]">
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 h-full relative overflow-hidden flex flex-col items-center justify-center text-center p-8">
                    
                    <div class="absolute inset-0 grid grid-cols-2 md:grid-cols-3 gap-4 p-8 opacity-20 filter blur-sm pointer-events-none">
                        <div class="bg-gray-300 rounded-xl h-32 md:h-48"></div><div class="bg-gray-300 rounded-xl h-32 md:h-48"></div><div class="bg-gray-300 rounded-xl h-32 md:h-48"></div>
                        <div class="bg-gray-300 rounded-xl h-32 md:h-48"></div><div class="bg-gray-300 rounded-xl h-32 md:h-48"></div><div class="bg-gray-300 rounded-xl h-32 md:h-48"></div>
                    </div>

                    <div class="relative z-10 max-w-lg mx-auto bg-white/80 backdrop-blur-md p-10 rounded-3xl border border-white shadow-2xl transform transition hover:scale-105 duration-300">
                        <div class="w-20 h-20 bg-gradient-to-tr from-ylosPink to-rose-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-pink-200">
                            <i class="fa-solid fa-lock text-white text-3xl"></i>
                        </div>
                        <h2 class="text-3xl font-extrabold text-gray-900 mb-3">Video Upskilling</h2>
                        <p class="text-gray-500 mb-6 leading-relaxed">
                            Materi eksklusif seputar kepemimpinan, manajemen waktu, dan *scholarship hack* sedang dalam tahap produksi. 
                        </p>
                        <div class="inline-flex items-center gap-2 bg-gray-900 text-white px-6 py-2 rounded-full font-bold text-sm animate-pulse shadow-lg">
                            <i class="fa-solid fa-hourglass-half"></i> Coming Soon
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-tugas" class="tab-content max-w-5xl mx-auto">
                <div class="bg-white p-10 rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center justify-center text-center min-h-[50vh]">
                    <img src="https://cdn3d.iconscout.com/3d/premium/thumb/task-checklist-5374465-4497332.png" alt="Task" class="w-48 h-48 object-contain mb-6 opacity-80 filter drop-shadow-xl">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Papan Penugasan</h2>
                    <p class="text-gray-500 max-w-md">Belum ada tugas yang diberikan. Selesaikan tahap administrasi dan tunggu instruksi selanjutnya dari panitia.</p>
                </div>
            </div>

            <div id="tab-pengaturan" class="tab-content max-w-3xl mx-auto">
                <div class="bg-white p-6 md:p-10 rounded-3xl shadow-sm border border-gray-100">
                    <h2 class="text-2xl font-bold text-gray-900 mb-8 border-b border-gray-100 pb-4">Informasi Akun</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Nama Lengkap</label>
                            <div class="px-5 py-4 bg-gray-50 rounded-xl border border-gray-200 font-medium text-gray-900" id="set-name">Memuat...</div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Asal Sekolah/Instansi</label>
                            <div class="px-5 py-4 bg-gray-50 rounded-xl border border-gray-200 font-medium text-gray-900" id="set-school">Memuat...</div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Email</label>
                            <div class="px-5 py-4 bg-gray-50 rounded-xl border border-gray-200 font-medium text-gray-500 flex justify-between items-center">
                                <span id="set-email">Memuat...</span>
                                <i class="fa-solid fa-lock text-gray-300"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">No. WhatsApp</label>
                            <div class="px-5 py-4 bg-gray-50 rounded-xl border border-gray-200 font-medium text-gray-900" id="set-phone">Memuat...</div>
                        </div>
                    </div>
                    
                    <div class="mt-10 pt-6 border-t border-gray-100 text-center">
                        <p class="text-xs text-gray-400 mb-4">Jika terdapat kesalahan data, silakan hubungi admin.</p>
                        <button onclick="contactAdmin()" class="bg-white border border-gray-300 text-gray-700 hover:border-gray-400 hover:bg-gray-50 px-6 py-2.5 rounded-full font-bold text-sm transition">
                            <i class="fa-solid fa-headset mr-2"></i> Hubungi Bantuan
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-12 text-center pb-8">
                <p class="text-xs text-gray-400 font-medium">Â© 2026 YLOS Dashboard System. All rights reserved.</p>
            </div>

        </div>
    </main>

    <script>
        const LINK_COMMITMENT_FEE = "https://lynk.id/ylos.id/1xd4663dpvrn/checkout?token=cGFyYW1zPSU1QiU1RCZiaWRfcHJpY2U9MCZxdHlfcHJvZD0x";
        const LINK_SELF_FUNDED = "https://lynk.id/ylos.id/er400x4wrlp1/checkout?token=cGFyYW1zPSU1QiU1RCZiaWRfcHJpY2U9MCZxdHlfcHJvZD0x";
        const WA_LINK_COMMITMENT = "https://chat.whatsapp.com/EeSgj62k95V2Xwp4eXLqOp?mode=gi_c"; 
        const WA_LINK_SELF_FUNDED = "https://chat.whatsapp.com/BvCU3Pv0zMvFrVFQ49Om5g?mode=gi_c"; 
        
        let CURRENT_PAYMENT_URL = "";
        let CURRENT_WA_LINK = "";

        // Fungsi Navigasi Tab / Sidebar
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
            
            const titles = {
                'overview': 'Beranda', 'materi': 'Modul & Materi',
                'video': 'Video Upskilling', 'tugas': 'Papan Penugasan', 'pengaturan': 'Pengaturan Akun'
            };
            document.getElementById('header-title').innerText = titles[tabId] || 'Dashboard';
            
            if(window.innerWidth < 1024) toggleSidebar();
            document.querySelector('.flex-1.overflow-y-auto').scrollTo({top: 0, behavior: 'smooth'});
        }

        // Fungsi Buka Tutup Sidebar Mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            if(sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        async function initTracking(session) {
            if(session) {
                await supabaseClient.rpc('update_user_presence');
                setInterval(async () => { await supabaseClient.rpc('update_user_presence'); }, 60000);
                document.addEventListener("visibilitychange", async function() {
                    if (document.visibilityState === 'hidden') await supabaseClient.rpc('update_user_presence');
                });
                const channel = supabaseClient.channel('online-users', { config: { presence: { key: session.user.id } } });
                channel.on('presence', { event: 'sync' }, () => {}).subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await channel.track({ email: session.user.email, page: 'Dashboard', login_time: new Date().toLocaleTimeString() });
                    }
                });
            }
        }

        async function logout() {
            await Swal.fire({ icon: 'success', title: 'Logout Berhasil', text: 'Sampai jumpa lagi!', timer: 1500, showConfirmButton: false });
            await supabaseClient.auth.signOut();
            window.location.replace('index.html');
        }

        function openLynkPayment() {
            if (!CURRENT_PAYMENT_URL) {
                Swal.fire('Error', 'Link pembayaran belum dimuat. Silakan refresh halaman.', 'error');
                return;
            }
            Swal.fire({
                title: 'Pembayaran Dibuka ðŸ’³',
                html: `Anda akan diarahkan ke halaman pembayaran aman via <b>LYNK</b>.`,
                imageUrl: 'LOGO YLOS 5x5.png', imageWidth: 80, imageHeight: 80,
                showCancelButton: true, confirmButtonText: 'Lanjut Bayar âž”', cancelButtonText: 'Batal', confirmButtonColor: '#FF85B3', cancelButtonColor: '#d33'
            }).then((result) => { if (result.isConfirmed) window.open(CURRENT_PAYMENT_URL, '_blank'); });
        }

        function joinWaGroup() { 
            if (CURRENT_WA_LINK) window.open(CURRENT_WA_LINK, '_blank'); 
            else Swal.fire('Error', 'Link grup belum tersedia. Silakan hubungi admin.', 'error');
        }
        
        function contactAdmin() { window.open(`https://wa.me/6281290774332?text=Halo Admin, saya butuh bantuan terkait akun saya.`, '_blank'); }

        async function loadDashboard(userId) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const isPreviewMode = urlParams.get('preview') === 'true';

                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                // ERROR HANDLING TAMBAHAN
                if (error || !profile) {
                    console.error("Gagal menarik data profile:", error);
                    Swal.fire('Oops!', 'Sistem gagal mengambil data profil kamu. Pastikan tabel "profiles" di Supabase dan sistem RLS-nya sudah di-setting dengan benar.', 'error');
                    
                    // Reset text UI dari "Loading..." jadi info error
                    document.getElementById('dash-name').innerText = 'User!';
                    document.getElementById('sidebar-user-name').innerText = 'Data Error';
                    document.getElementById('dash-package').innerText = 'Tidak Ditemukan';
                    document.getElementById('dash-status-text').innerText = 'Data Error';
                    document.getElementById('dash-status-badge').innerText = 'Data Error';
                    document.getElementById('announcement-content').innerHTML = '<p class="text-red-500 font-bold p-4 text-center">Gagal memuat database.</p>';
                    document.getElementById('modules-content').innerHTML = '<p class="text-red-500 font-bold col-span-full p-4 text-center">Gagal memuat database.</p>';
                    return;
                }

                // Jika data profile aman, jalankan UI biasa
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (isPreviewMode) {
                    profile.role = 'user'; profile.payment_status = 'Lunas'; profile.full_name = "Tampilan Peserta (Preview)";
                }

                // Isi Data Nama
                const firstName = profile.full_name.split(' ')[0];
                document.getElementById('dash-name').innerText = firstName + '!';
                document.getElementById('sidebar-user-name').innerText = profile.full_name;
                document.getElementById('dash-package').innerText = profile.package_type;
                
                // Isi Data Tab Pengaturan
                document.getElementById('set-name').innerText = profile.full_name;
                document.getElementById('set-school').innerText = profile.school || '-';
                document.getElementById('set-email').innerText = session?.user?.email || '-';
                document.getElementById('set-phone').innerText = profile.phone || '-';
                
                // Logika Jalur & Link
                if (profile.package_type && (profile.package_type.includes('Mandiri') || profile.package_type.includes('Self Funded'))) {
                    CURRENT_PAYMENT_URL = LINK_SELF_FUNDED;
                    CURRENT_WA_LINK = WA_LINK_SELF_FUNDED;
                } else {
                    CURRENT_PAYMENT_URL = LINK_COMMITMENT_FEE;
                    CURRENT_WA_LINK = WA_LINK_COMMITMENT;
                }
                
                const statusBadge = document.getElementById('dash-status-badge');
                const statusText = document.getElementById('dash-status-text');
                const btnPay = document.getElementById('payment-actions');
                const waGroup = document.getElementById('wa-group-access');
                
                const isLunas = profile.payment_status === 'Lunas';

                if(isLunas) {
                    statusBadge.innerText = 'Akun Aktif (Lunas)';
                    statusBadge.className = 'hidden md:inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold border border-green-200';
                    statusText.innerText = 'LUNAS (Verified)';
                    statusText.className = 'text-sm font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded inline-block';
                    btnPay.classList.add('hidden');
                    waGroup.classList.remove('hidden');
                } else {
                    statusBadge.innerText = 'Menunggu Pembayaran';
                    statusBadge.className = 'hidden md:inline-block px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold border border-yellow-200';
                    statusText.innerText = 'Menunggu Pembayaran';
                    statusText.className = 'text-sm font-bold text-yellow-600';
                    btnPay.classList.remove('hidden');
                    waGroup.classList.add('hidden');
                }

                // Cek Role Admin
                if(profile.role === 'admin') {
                    document.getElementById('btn-admin-panel').classList.remove('hidden');
                } 
                
                // Load CMS
                loadCMSContent(isLunas);

            } catch (err) {
                console.error("Kesalahan sistem utama saat memuat dashboard:", err);
            }
        }

        async function loadCMSContent(isLunas) {
            // 1. Load Pengumuman
            const { data: announcements, error: errAnn } = await supabaseClient.from('announcements').select('*').eq('is_active', true).order('order_index', {ascending: true});
            const annContainer = document.getElementById('announcement-content');
            
            if (errAnn) {
                console.error(errAnn);
                annContainer.innerHTML = '<p class="text-red-500">Gagal mengambil pengumuman. (Cek tabel announcements/RLS)</p>';
            } else if(announcements && announcements.length > 0) {
                annContainer.innerHTML = '';
                announcements.forEach(ann => {
                    let isLocked = (ann.is_premium === true) && !isLunas;

                    if (isLocked) {
                        annContainer.innerHTML += `
                            <div class="bg-gray-50 border-l-4 border-gray-300 p-5 rounded-r-2xl border border-y-gray-100 border-r-gray-100 mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <h4 class="font-bold text-gray-500 text-base flex items-center gap-2"><i class="fa-solid fa-lock"></i> Pengumuman Terkunci</h4>
                                    <span class="bg-gradient-to-r from-ylosPink to-rose-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">Eksklusif Member</span>
                                </div>
                                <p class="text-sm text-gray-400 italic">Selesaikan pembayaran administrasi untuk melihat informasi penting ini.</p>
                            </div>
                        `;
                    } else {
                        annContainer.innerHTML += `
                            <div class="bg-blue-50/40 border-l-4 border-blue-500 p-5 rounded-r-2xl border border-y-blue-100 border-r-blue-100 mb-4 hover:bg-blue-50 transition duration-300">
                                <h4 class="font-bold text-gray-900 text-base mb-3">${ann.title}</h4>
                                <div class="prose text-sm text-gray-600">
                                    ${ann.content} 
                                </div>
                                <div class="flex items-center justify-between mt-4 text-xs text-gray-400 font-medium pt-3 border-t border-blue-100/50">
                                    <div class="flex items-center gap-2">
                                        <div class="w-5 h-5 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center"><i class="fa-solid fa-user-shield text-[8px]"></i></div>
                                        <span>Tim Admin YLOS</span>
                                    </div>
                                    <div class="flex items-center gap-1"><i class="fa-regular fa-clock"></i> ${new Date(ann.created_at).toLocaleDateString()}</div>
                                </div>
                            </div>
                        `;
                    }
                });

                document.querySelectorAll('.prose img').forEach(img => {
                    img.onclick = function() {
                        Swal.fire({
                            imageUrl: this.src, width: 'auto', padding: 0, showConfirmButton: false, showCloseButton: true,
                            background: 'transparent', backdrop: 'rgba(0,0,0,0.85)', customClass: { popup: 'rounded-xl overflow-hidden' }
                        });
                    };
                });
            } else {
                annContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fa-solid fa-box-open text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm font-medium">Belum ada pengumuman.</p>
                    </div>
                `;
            }

            // 2. Load Modul
            const { data: modules, error: errMod } = await supabaseClient.from('modules').select('*').order('order_index', {ascending: true});
            const modContainer = document.getElementById('modules-content');
            
            if (errMod) {
                 console.error(errMod);
                 modContainer.innerHTML = '<p class="text-red-500 col-span-full">Gagal mengambil materi. (Cek tabel modules/RLS)</p>';
            } else if(modules && modules.length > 0) {
                modContainer.innerHTML = '';
                modules.forEach(mod => {
                    let isLocked = mod.is_premium && !isLunas;
                    let icon = mod.category === 'Video' ? 'fa-circle-play' : 'fa-file-lines';
                    let iconColor = mod.category === 'Video' ? 'text-rose-500 bg-rose-50' : 'text-indigo-500 bg-indigo-50';
                    let action = isLocked 
                        ? `<button disabled class="mt-4 w-full flex items-center justify-center gap-2 py-2.5 bg-gray-100 text-gray-400 rounded-xl text-xs font-bold cursor-not-allowed border border-gray-200"><i class="fa-solid fa-lock"></i> Terkunci</button>`
                        : `<a href="${mod.link_url}" target="_blank" class="mt-4 w-full flex items-center justify-center gap-2 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-xs font-bold transition shadow-md shadow-indigo-100 transform hover:-translate-y-0.5">Akses Materi <i class="fa-solid fa-arrow-up-right-from-square"></i></a>`;
                    
                    let opacity = isLocked ? 'opacity-60 grayscale-[50%]' : '';
                    let titleColor = isLocked ? 'text-gray-500' : 'text-gray-900 group-hover:text-indigo-700';

                    modContainer.innerHTML += `
                        <div class="flex flex-col p-5 border border-gray-100 rounded-2xl bg-white hover:shadow-lg hover:border-indigo-100 transition duration-300 ${opacity} group">
                            <div class="flex items-start justify-between mb-2">
                                <div class="${iconColor} w-12 h-12 rounded-xl flex items-center justify-center text-xl shadow-sm ${!isLocked ? 'group-hover:scale-110' : ''} transition-transform duration-300">
                                    <i class="fa-solid ${icon}"></i>
                                </div>
                                ${isLocked ? '<span class="inline-block px-2 py-1 bg-red-50 border border-red-100 text-red-500 text-[10px] font-bold rounded-lg shadow-sm"><i class="fa-solid fa-lock text-[8px] mr-1"></i> Premium</span>' : ''}
                            </div>
                            
                            <h4 class="font-bold ${titleColor} text-base transition mt-2 leading-snug h-10 line-clamp-2">${mod.title}</h4>
                            <span class="inline-block mt-2 px-2 py-1 bg-gray-50 text-gray-500 text-[10px] uppercase font-bold tracking-wider rounded border border-gray-200 w-max">${mod.category}</span>
                            
                            <div class="mt-auto">
                                ${action}
                            </div>
                        </div>
                    `;
                });
            } else {
                modContainer.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-16 text-gray-400">
                        <i class="fa-solid fa-folder-open text-5xl mb-4 opacity-30"></i>
                        <p class="text-sm font-medium">Modul pembelajaran masih kosong.</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>