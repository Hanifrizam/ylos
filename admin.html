<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YLOS Admin - Security Check</title>

     <link rel="icon" type="image/png" href="LOGO YLOS 5x5.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#DB2777', secondary: '#BE185D', surface: '#F8FAFC' },
                    boxShadow: { 'soft': '0 10px 40px -10px rgba(0,0,0,0.08)' }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; color: #1E293B; overflow: hidden; }
        
        /* --- SECURITY LOADER --- */
        #security-overlay {
            position: fixed; inset: 0; background: #ffffff; z-index: 9999999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease-out;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid #DB2777; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ANIMATIONS & INTERACTIONS --- */
        .btn-press { transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-press:active { transform: scale(0.94); }
        .btn-press:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(219, 39, 119, 0.3); }
        
        .sidebar-item { transition: all 0.3s ease; border-radius: 12px; margin-bottom: 6px; position: relative; overflow: hidden; }
        .sidebar-item:hover { background-color: #FFF1F2; color: #DB2777; padding-left: 18px; }
        .sidebar-item.active { background: linear-gradient(135deg, #FFF1F2 0%, #FFFFFF 100%); color: #DB2777; font-weight: 700; box-shadow: 0 4px 15px rgba(236, 72, 153, 0.1); border-left: 4px solid #DB2777; }
        
        .content-section { display: none !important; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .content-section.active { display: flex !important; flex-direction: column; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- CARDS & GLASS --- */
        .glass-card { background: white; border-radius: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 10px 15px -3px rgba(0, 0, 0, 0.05); border: 1px solid #F1F5F9; transition: all 0.3s; }
        @media (min-width: 768px) {
            .glass-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); border-color: #FBCFE8; }
        }

        /* --- TABLE MODERN --- */
        .modern-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 600px; }
        .modern-table th { color: #64748B; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 0 20px 10px 20px; text-align: left; font-weight: 700; }
        .modern-table tr { background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.2s; border-radius: 12px; }
        .modern-table td { padding: 16px 20px; border-top: 1px solid #F8FAFC; border-bottom: 1px solid #F8FAFC; }
        .modern-table td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; border-left: 1px solid #F8FAFC; }
        .modern-table td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; border-right: 1px solid #F8FAFC; }

        /* --- DIGISIGN UI --- */
        #pdf-scroll-container { background-color: #334155; padding: 20px; overflow: auto; flex: 1; display: flex; justify-content: center; position: relative; background-image: radial-gradient(#475569 1px, transparent 1px); background-size: 24px 24px; min-height: 300px; }
        #pdf-wrapper { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 4px; transition: transform 0.3s; position: relative; }
        .signature-box {
            position: absolute; width: 160px; height: 80px;
            border: 2px dashed #DB2777; background-color: rgba(253, 242, 248, 0.6);
            cursor: grab; z-index: 100; top: 100px; left: 100px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; backdrop-filter: blur(4px);
            resize: both; overflow: hidden; min-width: 50px; min-height: 30px;
            box-shadow: 0 4px 15px rgba(219, 39, 119, 0.2);
            touch-action: none;
        }
        .signature-box::after { content: 'â¤¡'; position: absolute; bottom: 0; right: 0; color: #DB2777; font-size: 12px; padding: 2px; cursor: se-resize; line-height: 10px; }
        .signature-box img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }

        /* --- CALENDAR --- */
        .swal2-container { z-index: 999999 !important; }
        .swal-cal-container { display: flex; flex-direction: column; gap: 1rem; text-align: left; }
        .swal-cal-row { display: flex; gap: 10px; }
        .swal-cal-group { flex: 1; display: flex; flex-direction: column; }
        .swal-cal-label { font-size: 11px; font-weight: 800; color: #64748B; text-transform: uppercase; margin-bottom: 4px; margin-left: 4px; }
        .swal-cal-input { width: 100% !important; margin: 0 !important; border-radius: 12px !important; border: 1px solid #E2E8F0 !important; font-size: 14px !important; }
        .fc { background: white; padding: 20px; border-radius: 24px; z-index: 1; }
        .fc-toolbar-title { font-size: 1.1rem !important; font-weight: 800 !important; color: #334155; }
        .fc-button { padding: 4px 10px !important; font-size: 0.8rem !important; }
        .fc-button-primary { background-color: #DB2777 !important; border: none !important; border-radius: 8px !important; }

        /* --- UTILS --- */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
        
        .ds-tab { position: relative; color: #64748B; font-weight: 600; transition: all 0.3s; white-space: nowrap; }
        .ds-tab::after { content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 3px; background: #DB2777; transition: all 0.3s; transform: translateX(-50%); border-radius: 10px; }
        .ds-tab.active { color: #DB2777; }
        .ds-tab.active::after { width: 60%; }

        #mobile-backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        /* QUILL EDITOR CUSTOM STYLES */
        .ql-toolbar { border-top-left-radius: 12px; border-top-right-radius: 12px; border-color: #E2E8F0 !important; background-color: #F8FAFC; }
        .ql-container { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; border-color: #E2E8F0 !important; background-color: white; font-family: 'Plus Jakarta Sans', sans-serif !important; font-size: 14px !important; }
        .ql-editor { min-height: 250px; }

        /* --- DRAG & DROP ENHANCEMENTS --- */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #FFF1F2; /* Pink Muda */
            border: 2px dashed #DB2777;
            transform: scale(0.98);
        }
        .sortable-drag {
            cursor: grabbing;
            opacity: 1;
            background: white;
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 9999;
        }
        .draggable-item {
            touch-action: none; /* Penting untuk mobile agar tidak scroll saat drag */
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm md:text-base">

<style> body { display: none; } /* Default sembunyi agar tidak kedip */ </style>
    
    <div id="security-overlay">
        <div class="loader-spinner mb-4"></div>
        <h2 class="text-xl font-extrabold text-gray-800 tracking-tight">YLOS <span class="text-pink-600">Secure</span></h2>
        <p class="text-xs text-gray-400 font-mono mt-2" id="security-status">Verifying Admin Privileges...</p>
    </div>

    <div id="mobile-backdrop" onclick="toggleSidebar()" class="fixed inset-0 z-40 hidden md:hidden transition-opacity"></div>

    <aside id="main-sidebar" class="fixed inset-y-0 left-0 w-72 bg-white border-r border-gray-100 flex flex-col z-50 shadow-soft transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-300 ease-in-out">
        <div class="h-20 flex items-center px-8 justify-between md:justify-start">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-pink-500 to-rose-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-pink-200">Y</div>
                <div><span class="text-xl font-extrabold text-gray-900 tracking-tight">YLOS</span><span class="text-[10px] block font-bold text-gray-400 -mt-1 tracking-widest">ADMIN</span></div>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-pink-600"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto px-5 py-2 space-y-8 custom-scrollbar">
            <div>
                <p class="px-2 text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3 opacity-70">Main Menu</p>
                <div onclick="switchTab('dashboard')" id="menu-dashboard" class="sidebar-item active px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard</div>
                <div onclick="switchTab('calendar')" id="menu-calendar" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-regular fa-calendar-check w-5 text-center"></i> Kalender</div>
            </div>
            
            <div>
                <p class="px-2 text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3 opacity-70">Digital Office</p>
                <div onclick="switchTab('digisign')" id="menu-digisign" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm group cursor-pointer">
                    <i class="fa-solid fa-file-signature w-5 text-center group-hover:scale-110 transition"></i> DigiSign 
                    <span class="bg-gradient-to-r from-pink-500 to-rose-500 text-white text-[9px] px-2 py-0.5 rounded-full ml-auto font-bold shadow-sm">PRO</span>
                </div>
                 <div onclick="switchTab('tracking')" id="menu-tracking" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-stopwatch w-5 text-center"></i> Progress Update <span class="text-[9px] text-pink-500 bg-pink-50 px-1.5 py-0.5 rounded ml-auto font-bold">NEW</span></div>
            </div>

            <div>
                <p class="px-2 text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3 opacity-70">Marketing</p>
                <div onclick="switchTab('blast')" id="menu-blast" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer group">
                    <i class="fa-solid fa-paper-plane w-5 text-center group-hover:text-pink-500 transition"></i> Email Blast
                </div>
            </div>
            
            <div>
                <p class="px-2 text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3 opacity-70">Database</p>
                <div onclick="switchTab('users')" id="menu-users" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-users w-5 text-center"></i> Peserta</div>
                <div onclick="switchTab('verification')" id="menu-verification" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-envelope-open-text w-5 text-center"></i> Verifikasi</div>
            </div>

            <div>
                <p class="px-2 text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3 opacity-70">System</p>
                <div onclick="switchTab('announcements')" id="menu-announcements" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-bullhorn w-5 text-center"></i> Pengumuman</div>
                <div onclick="switchTab('modules')" id="menu-modules" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-folder-open w-5 text-center"></i> Materi</div>
                <div onclick="switchTab('preview')" id="menu-preview" class="sidebar-item px-4 py-3.5 flex items-center gap-3 text-sm cursor-pointer"><i class="fa-solid fa-mobile-screen w-5 text-center"></i> Live Preview</div>
            </div>
        </div>

        <div class="p-6 border-t border-gray-50 bg-gray-50/50 space-y-3">
            <a href="index.html" class="btn-press w-full flex items-center justify-center gap-2 text-xs font-bold text-gray-600 bg-white py-3 rounded-xl border border-gray-200 shadow-sm hover:text-pink-600">
                <i class="fa-solid fa-globe"></i> <span class="md:inline">Web Utama</span>
            </a>
            <button onclick="logout()" class="btn-press w-full flex items-center justify-center gap-2 text-xs font-bold text-white bg-gray-900 py-3 rounded-xl hover:bg-black shadow-lg">
                <i class="fa-solid fa-right-from-bracket"></i> Keluar
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
        
        <header class="h-16 bg-white border-b border-gray-100 flex items-center justify-between px-4 md:px-8 flex-shrink-0 z-30">
            
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden w-10 h-10 flex items-center justify-center bg-gray-50 rounded-xl text-gray-600 active:bg-gray-100">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>
                <span class="md:hidden font-extrabold text-lg text-gray-900">YLOS <span class="text-pink-600">Admin</span></span>
                <span class="hidden md:block text-sm font-bold text-gray-400">Overview Panel</span>
            </div>

            <div class="flex items-center gap-3">
                 <div class="text-right hidden md:block">
                     <span id="admin-name-display" class="text-sm font-bold text-gray-800 block">Loading...</span>
                     <span class="text-[10px] text-gray-500 font-medium">Administrator</span>
                 </div>
                 <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center font-bold text-sm md:text-lg border-2 border-white shadow-sm">A</div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth bg-[#F8FAFC]">
            
            <div id="section-dashboard" class="content-section active space-y-6 md:space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight">Dashboard</h1>
                        <p class="text-gray-500 text-xs md:text-sm mt-1">Ringkasan aktivitas & performa sistem.</p>
                    </div>
                    <span class="bg-white border border-green-100 text-green-700 px-3 py-1.5 rounded-full text-[10px] md:text-xs font-bold flex items-center gap-2 shadow-sm">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> System Online
                    </span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="glass-card p-5 flex flex-col justify-between h-32 md:h-40 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-50 rounded-full transition-transform group-hover:scale-150 duration-500"></div>
                        <div class="relative z-10 flex items-center gap-3"><div class="w-10 h-10 md:w-12 md:h-12 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center text-lg md:text-xl shadow-sm"><i class="fa-solid fa-users"></i></div><span class="text-xs md:text-sm font-bold text-gray-500 uppercase tracking-wide">Total Peserta</span></div>
                        <div class="relative z-10 text-3xl md:text-4xl font-extrabold text-gray-900" id="stat-total">0</div>
                    </div>
                    <div class="glass-card p-5 flex flex-col justify-between h-32 md:h-40 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-green-50 rounded-full transition-transform group-hover:scale-150 duration-500"></div>
                        <div class="relative z-10 flex items-center gap-3"><div class="w-10 h-10 md:w-12 md:h-12 rounded-2xl bg-green-100 text-green-600 flex items-center justify-center text-lg md:text-xl shadow-sm"><i class="fa-solid fa-check-circle"></i></div><span class="text-xs md:text-sm font-bold text-gray-500 uppercase tracking-wide">Lunas</span></div>
                        <div class="relative z-10 text-3xl md:text-4xl font-extrabold text-green-600" id="stat-lunas">0</div>
                    </div>
                    <div class="glass-card p-5 flex flex-col justify-between h-32 md:h-40 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-50 rounded-full transition-transform group-hover:scale-150 duration-500"></div>
                        <div class="relative z-10 flex items-center gap-3"><div class="w-10 h-10 md:w-12 md:h-12 rounded-2xl bg-yellow-100 text-yellow-600 flex items-center justify-center text-lg md:text-xl shadow-sm"><i class="fa-solid fa-clock"></i></div><span class="text-xs md:text-sm font-bold text-gray-500 uppercase tracking-wide">Pending</span></div>
                        <div class="relative z-10 text-3xl md:text-4xl font-extrabold text-yellow-600" id="stat-pending">0</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-2 glass-card p-5 md:p-8"><h3 class="font-bold text-gray-800 mb-6 text-base md:text-lg">Analitik Pendaftaran</h3><div class="h-60 md:h-72"><canvas id="userChart"></canvas></div></div>
                    <div class="glass-card p-5 md:p-8 flex flex-col h-80 md:h-[26rem]">
                        <div class="flex justify-between mb-6 items-center"><h3 class="font-bold text-gray-800 text-base md:text-lg">User Online</h3><span id="online-count" class="text-[10px] bg-green-100 text-green-700 px-3 py-1 rounded-full font-bold">0 Active</span></div>
                        <div id="active-user-list" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar"><div class="text-center py-12 text-gray-400 text-sm italic">Menunggu user login...</div></div>
                    </div>
                </div>
            </div>

            <div id="section-calendar" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <div><h2 class="text-xl md:text-2xl font-bold text-gray-900">Jadwal</h2><p class="text-gray-500 text-xs mt-1">Klik tanggal untuk event.</p></div>
                </div>
                <div id="calendar" class="text-xs md:text-sm"></div>
            </div>
            
            <div id="section-tracking" class="content-section space-y-6">
                
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 glass-card p-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900 flex items-center gap-2"><i class="fa-solid fa-folder-open text-pink-500"></i> Progress Update</h2>
                        <p class="text-gray-600 text-xs mt-1">Sistem penyimpanan progress kerja tim berbasis folder.</p>
                    </div>
                    <div id="tracking-controls" class="w-full md:w-auto">
                        <button onclick="addFolder()" class="w-full md:w-auto px-4 py-2 rounded-xl text-sm font-bold transition bg-gray-900 text-white shadow-lg hover:bg-black flex items-center justify-center gap-2">
                            <i class="fa-solid fa-plus"></i> Tambah Folder
                        </button>
                    </div>
                </div>

                <div id="view-folders" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                    </div>

                <div id="view-folder-detail" class="hidden glass-card p-6 flex flex-col gap-4">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-100 pb-4 gap-4">
                        <div class="flex items-center gap-3">
                            <button onclick="closeFolder()" class="text-gray-400 hover:text-pink-600 bg-gray-50 hover:bg-pink-50 w-8 h-8 rounded-lg flex items-center justify-center transition">
                                <i class="fa-solid fa-arrow-left"></i>
                            </button>
                            <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i class="fa-solid fa-folder text-yellow-400"></i> <span id="current-folder-title">Nama Folder</span></h3>
                        </div>
                        <button onclick="addProgress()" class="w-full md:w-auto btn-press bg-pink-600 text-white px-4 py-2 rounded-xl font-bold text-xs shadow-md hover:bg-pink-700 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-pen"></i> Tambah Progress
                        </button>
                    </div>
                    
                    <div id="progress-list" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                        </div>
                </div>

            </div>

            <div id="section-digisign" class="content-section space-y-6">
                 <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 glass-card p-6">
                    <div><h2 class="text-xl md:text-2xl font-bold text-gray-900 flex items-center gap-2"><i class="fa-solid fa-file-contract text-pink-500"></i> DigiSign Pro</h2><p class="text-gray-600 text-xs mt-1">Platform tanda tangan digital.</p></div>
                    <button onclick="openUploadModal()" class="btn-press w-full md:w-auto bg-gray-900 text-white px-6 py-3 rounded-xl font-bold text-xs md:text-sm shadow-lg flex items-center justify-center gap-2"><i class="fa-solid fa-cloud-arrow-up"></i> Request TTD</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="glass-card p-5 flex items-center justify-between"><div><p class="text-[10px] text-gray-400 font-bold uppercase">Inbox Saya</p><h3 class="text-2xl font-extrabold text-pink-600 mt-1" id="ds-need-sign">0</h3></div><div class="w-10 h-10 bg-pink-50 rounded-xl flex items-center justify-center text-pink-500 text-lg"><i class="fa-solid fa-inbox"></i></div></div>
                    <div class="glass-card p-5 flex items-center justify-between"><div><p class="text-[10px] text-gray-400 font-bold uppercase">Terkirim</p><h3 class="text-2xl font-extrabold text-blue-600 mt-1" id="ds-sent-personal">0</h3></div><div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500 text-lg"><i class="fa-regular fa-paper-plane"></i></div></div>
                    <div class="glass-card p-5 flex items-center justify-between"><div><p class="text-[10px] text-gray-400 font-bold uppercase">Selesai</p><h3 class="text-2xl font-extrabold text-green-600 mt-1" id="ds-completed-global">0</h3></div><div class="w-10 h-10 bg-green-50 rounded-xl flex items-center justify-center text-green-500 text-lg"><i class="fa-solid fa-check-double"></i></div></div>
                </div>
                <div class="glass-card overflow-hidden">
                    <div class="flex border-b border-gray-100 p-2 gap-2 bg-gray-50/50 overflow-x-auto no-scrollbar">
                        <button onclick="fetchDigiSignDocs('inbox')" id="tab-inbox" class="ds-tab flex-1 py-3 text-xs md:text-sm font-bold active px-4">Inbox <span id="badge-inbox" class="hidden ml-1 bg-pink-500 text-white text-[9px] px-1.5 py-0.5 rounded-full shadow-sm">0</span></button>
                        <button onclick="fetchDigiSignDocs('sent')" id="tab-sent" class="ds-tab flex-1 py-3 text-xs md:text-sm font-bold px-4">Request</button>
                        <button onclick="fetchDigiSignDocs('completed')" id="tab-completed" class="ds-tab flex-1 py-3 text-xs md:text-sm font-bold px-4">Arsip</button>
                    </div>
                    <div class="overflow-x-auto"><table class="modern-table w-full"><thead><tr><th>Dokumen</th><th>Tracking Flow</th><th>Status</th><th class="text-center">Aksi</th></tr></thead><tbody id="digisign-list"></tbody></table></div>
                </div>
            </div>

            <div id="section-blast" class="content-section space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fa-solid fa-paper-plane text-pink-600"></i> Email Blast
                        </h2>
                        <p class="text-gray-500 text-xs mt-1">Kirim email massal ke peserta atau database.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card p-6 flex flex-col gap-4">
                        <h3 class="font-bold text-gray-800 border-b border-gray-100 pb-2">1. Template Pesan</h3>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Subject Email</label>
                            <input type="text" id="blast-subject" placeholder="Contoh: Pengumuman Penting YLOS" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold focus:bg-white transition outline-none focus:border-pink-500">
                        </div>
                        <div class="flex-1 flex flex-col">
                            <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Isi Pesan (Rich Text)</label>
                            <div class="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden focus-within:border-pink-500 transition flex-1 flex flex-col">
                                <div id="editor-container" style="height: 300px; font-family: 'Plus Jakarta Sans', sans-serif;"></div>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1 italic">*Support Font, Warna, Gambar, dan Link (Ala MS Word).</p>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6">
                        <div class="glass-card p-6 flex flex-col gap-4">
                            <h3 class="font-bold text-gray-800 border-b border-gray-100 pb-2 flex justify-between items-center">
                                2. Daftar Penerima
                                <span id="recipient-count" class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px]">0 Email</span>
                            </h3>
                            
                            <div class="p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 hover:bg-white hover:border-pink-400 transition text-center cursor-pointer group relative">
                                <input type="file" id="excel-input" accept=".xlsx, .xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="processExcel(this)">
                                <div class="pointer-events-none">
                                    <i class="fa-solid fa-file-excel text-2xl text-green-600 mb-2 group-hover:scale-110 transition"></i>
                                    <p class="text-sm font-bold text-gray-600">Import dari Excel</p>
                                    <p class="text-[10px] text-gray-400">Klik atau drag file .xlsx ke sini</p>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase block mb-1">List Email (Manual)</label>
                                <textarea id="blast-recipients" class="w-full h-32 p-3 bg-gray-50 border border-gray-200 rounded-xl text-xs font-mono focus:bg-white transition outline-none focus:border-pink-500" placeholder="email1@example.com, email2@example.com... (Pisahkan dengan koma atau enter)" onkeyup="updateRecipientCount()"></textarea>
                            </div>
                        </div>

                        <div class="glass-card p-6">
                            <h3 class="font-bold text-gray-800 border-b border-gray-100 pb-2 mb-4">3. Eksekusi</h3>
                            
                            <div id="blast-progress-container" class="hidden mb-4">
                                <div class="flex justify-between text-xs font-bold text-gray-600 mb-1">
                                    <span id="blast-status-text">Mengirim...</span>
                                    <span id="blast-percent">0%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                                    <div id="blast-bar" class="bg-gradient-to-r from-pink-500 to-rose-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <p class="text-[10px] text-gray-400 mt-1 text-center" id="blast-detail">0/0 terkirim</p>
                            </div>

                            <button onclick="startBlast()" id="btn-blast" class="btn-press w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-sm shadow-lg hover:bg-black flex items-center justify-center gap-2">
                                <i class="fa-solid fa-rocket"></i> BLAST SEKARANG
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="signing-modal" class="fixed inset-0 bg-gray-900/95 z-[100] hidden flex flex-col transition-opacity duration-300">
    <div class="bg-white h-auto py-3 px-4 md:h-16 md:px-6 flex flex-col md:flex-row justify-between items-center border-b border-gray-200 shadow-sm z-50 gap-2 md:gap-0">
        <div class="flex items-center gap-3 w-full md:w-auto">
            <div class="w-8 h-8 bg-pink-100 rounded-lg flex items-center justify-center text-pink-600 flex-shrink-0"><i class="fa-solid fa-pen-nib"></i></div>
            <div class="flex-1 min-w-0"><h3 class="font-bold text-gray-900 leading-tight text-sm">Signing Room</h3><p class="text-[10px] text-gray-500 truncate" id="doc-name-display">Loading...</p></div>
        </div>

        <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1 order-3 md:order-2 w-full md:w-auto justify-center md:justify-start mt-2 md:mt-0">
            <button onclick="changePdfPage(-1)" id="btn-prev-page" class="w-8 h-8 flex items-center justify-center rounded-md bg-white text-gray-600 shadow-sm hover:text-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="page-indicator" class="text-xs font-bold text-gray-700 min-w-[60px] text-center">Page 1/1</span>
            <button onclick="changePdfPage(1)" id="btn-next-page" class="w-8 h-8 flex items-center justify-center rounded-md bg-white text-gray-600 shadow-sm hover:text-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <div class="flex gap-3 w-full md:w-auto justify-end order-2 md:order-3">
            <button onclick="closeSigningModal()" class="flex-1 md:flex-none px-4 py-2 text-xs md:text-sm font-bold text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition border border-gray-200 md:border-none">Batal</button>
            <button onclick="saveSignedDocument()" class="flex-1 md:flex-none btn-press px-5 py-2 text-xs md:text-sm font-bold text-white bg-gradient-to-r from-pink-600 to-rose-600 rounded-lg shadow-md flex items-center justify-center gap-2"><i class="fa-solid fa-check"></i> Kirim</button>
        </div>
    </div>
    
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
        <div class="w-full md:w-72 bg-white border-b md:border-b-0 md:border-r border-gray-200 flex flex-col z-40 shadow-xl flex-shrink-0 order-1 md:order-1 h-auto max-h-[40vh] md:max-h-full overflow-y-auto">
            <div class="p-4 md:p-6 border-b border-gray-100">
                <h4 class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3">Area Tanda Tangan</h4>
                <div class="border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 relative overflow-hidden group hover:border-pink-400 transition h-24 md:h-32 mb-3 touch-none">
                    <canvas id="signature-pad" class="w-full h-full cursor-crosshair touch-none"></canvas>
                    <div class="absolute top-2 right-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition"><button onclick="clearPad()" class="bg-white p-1.5 rounded shadow text-red-500 hover:text-red-700 text-xs"><i class="fa-solid fa-trash"></i></button></div>
                </div>
                <button onclick="useSignature()" class="btn-press w-full bg-gray-800 text-white py-2 rounded-lg text-xs font-bold hover:bg-gray-900 shadow-lg">GUNAKAN</button>
            </div>
            <div class="p-4 md:p-6 flex-1 overflow-y-auto hidden md:block">
                <h4 class="text-[10px] font-extrabold text-gray-400 uppercase tracking-widest mb-3">Disimpan</h4>
                <div id="saved-sig-container" class="space-y-3"></div>
            </div>
            <div class="p-2 text-[10px] text-gray-400 border-t border-gray-100 text-center bg-gray-50 md:block hidden">ðŸ’¡ Drag pojok kanan bawah box untuk resize.</div>
        </div>
        <div id="pdf-scroll-container" class="order-2 md:order-2">
            <div id="pdf-wrapper"><canvas id="the-canvas"></canvas><div id="drag-signature" class="signature-box hidden"><img id="drag-sig-img" src="" alt="TTD"></div></div>
        </div>
    </div>
</div>

            <div id="section-users" class="content-section space-y-6">
                 <div class="glass-card p-4 md:p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            <h2 class="font-bold text-gray-800 text-lg md:text-xl">Data Peserta</h2>
                            <span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded font-bold">Total: <span id="table-total">0</span></span>
                        </div>
                        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto">
                             <div class="relative w-full md:w-auto">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cari nama..." class="pl-9 pr-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:outline-none focus:border-pink-500 transition shadow-sm w-full md:w-64">
                             </div>
                             <button onclick="exportToExcel()" class="btn-press text-xs bg-green-600 text-white px-4 py-2.5 rounded-xl font-bold shadow-sm hover:bg-green-700 flex items-center justify-center gap-2 w-full md:w-auto"><i class="fa-solid fa-file-excel"></i> Export</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto"><table class="modern-table"><thead><tr><th>Nama Lengkap</th><th>Sekolah</th><th>Kontak</th><th>Status Pembayaran</th><th>Last Seen</th><th class="text-center">Aksi</th></tr></thead><tbody id="userTableBody"></tbody></table></div>
                </div>
            </div>

            <div id="section-verification" class="content-section space-y-6">
                 <div class="glass-card p-4 md:p-6">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div><h2 class="font-bold text-gray-800 text-lg md:text-xl">Bantuan Verifikasi</h2><p class="text-xs text-gray-500 mt-1">Kirim ulang link login.</p></div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <div class="relative w-full md:w-64">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400 text-xs"></i>
                                <input type="text" id="searchVerification" onkeyup="filterVerification()" placeholder="Cari email/nama..." class="pl-9 pr-4 py-2.5 rounded-xl border border-gray-200 text-sm focus:outline-none focus:border-pink-500 transition shadow-sm w-full">
                            </div>
                            <button onclick="fetchUsers()" class="btn-press text-xs bg-white border border-gray-200 text-gray-600 px-3 py-2 rounded-xl font-bold hover:bg-gray-50 flex items-center gap-2"><i class="fa-solid fa-rotate-right"></i> <span class="hidden md:inline">Refresh</span></button>
                        </div>
                    </div>
                    <div class="overflow-x-auto"><table class="modern-table"><thead><tr><th>Nama</th><th>Email</th><th>WhatsApp</th><th>Status Pendaftaran</th><th>Status Login</th><th class="text-center">Aksi</th></tr></thead><tbody id="verification-list"></tbody></table></div>
                </div>
            </div>

            <div id="section-announcements" class="content-section space-y-6">
                 <div class="flex justify-between items-center">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900">Pengumuman (Rich Text)</h2>
                    <span class="text-[10px] text-gray-500 bg-white px-3 py-1 rounded-full border shadow-sm flex items-center gap-1"><i class="fa-solid fa-up-down-left-right"></i> Drag untuk urutkan</span>
                </div>
                
                <div class="glass-card p-4 md:p-6 mb-6">
                    <div class="space-y-4">
                        <input id="announce-title" class="w-full p-3 md:p-4 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold focus:bg-white transition outline-none focus:border-pink-500" placeholder="Judul Pengumuman">
                        
                        <div class="bg-gray-50 border border-gray-200 rounded-xl overflow-hidden focus-within:border-pink-500 transition flex-1 flex flex-col">
                            <div id="announce-editor-container" style="height: 200px; font-family: 'Plus Jakarta Sans', sans-serif;"></div>
                        </div>

                        <div class="flex justify-end gap-2" id="announce-buttons">
                            <button onclick="cancelEditAnnounce()" id="btn-cancel-announce" class="hidden btn-press px-6 py-3 rounded-xl font-bold text-sm bg-gray-200 text-gray-600">Batal</button>
                            <button onclick="saveAnnounce()" id="btn-save-announce" class="btn-press w-full md:w-auto bg-pink-600 text-white px-8 py-3 rounded-xl font-bold text-sm shadow-lg">Posting</button>
                        </div>
                    </div>
                </div>
                
                <div id="announcement-list" class="space-y-3"></div>
            </div>

            <div id="section-modules" class="content-section space-y-6">
                 <div class="flex justify-between items-center"><h2 class="text-xl md:text-2xl font-bold text-gray-900">Materi & Modul</h2></div>
                <div class="glass-card p-4 md:p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input id="mod-title" class="p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:border-pink-500 outline-none" placeholder="Judul Materi">
                        <input id="mod-link" class="p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:border-pink-500 outline-none" placeholder="Link File (Drive/Youtube)">
                        <select id="mod-category" class="p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:border-pink-500 outline-none"><option value="Document">Document</option><option value="Materi">Materi</option><option value="Video">Video</option></select>
                        <select id="mod-premium" class="p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:border-pink-500 outline-none"><option value="false">Free Access</option><option value="true">Premium Only</option></select>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="cancelEditModule()" id="btn-cancel-module" class="hidden btn-press px-6 py-3 rounded-xl font-bold text-sm bg-gray-200 text-gray-600">Batal</button>
                        <button onclick="saveModule()" id="btn-save-module" class="btn-press w-full bg-purple-600 text-white py-3 rounded-xl font-bold text-sm shadow-md">Upload Materi</button>
                    </div>
                </div>
                <div id="module-list" class="space-y-3"></div>
            </div>

            <div id="section-preview" class="content-section h-full flex flex-col space-y-4">
                 <div class="flex flex-col md:flex-row justify-between items-center glass-card p-4 gap-4">
                    <h2 class="font-bold text-gray-800 ml-2">Live Preview</h2>
                    <div class="flex gap-2 w-full md:w-auto justify-center">
                        <button onclick="setPreviewMode('desktop')" class="px-4 py-2 bg-gray-100 rounded-xl text-xs font-bold hover:bg-gray-200 transition">Desktop</button>
                        <button onclick="setPreviewMode('mobile')" class="px-4 py-2 bg-gray-100 rounded-xl text-xs font-bold hover:bg-gray-200 transition">Mobile</button>
                        <button onclick="reloadPreview()" class="px-4 py-2 bg-pink-50 text-pink-600 rounded-xl text-xs font-bold hover:bg-pink-100 transition"><i class="fa-solid fa-rotate"></i></button>
                    </div>
                </div>
                <div id="preview-container" class="flex-1 bg-gray-200 rounded-xl md:rounded-3xl flex justify-center items-center p-2 md:p-8 border border-gray-300 overflow-hidden shadow-inner min-h-[500px]">
                    <div id="preview-wrapper" class="w-full h-full bg-white shadow-2xl rounded-2xl border-[4px] md:border-[12px] border-gray-800 overflow-hidden transition-all duration-500 relative">
                        <iframe id="preview-frame" src="index.html?preview=true#dashboard" class="w-full h-full" frameborder="0"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG
        const supabaseUrl = 'https://jrslgkxwjvugvgakxwsd.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impyc2xna3h3anZ1Z3ZnYWt4d3NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTYyNDYsImV4cCI6MjA4NTM5MjI0Nn0.q2GGd0kdKt7KGWt7QpfeP0UUBOStmuUH51caPoCrmMk'; 

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
        let allUsers=[], calendarInstance, signaturePad, currentDocId, pdfBytes, currentFilename, mySavedSignature = null, activityChart;
        
        // Global var untuk Quill Editor
        var quillBlast, quillAnnounce;
        
        // Global var untuk Edit Mode
        var editingAnnounceId = null;
        var editingModuleId = null;

        // Variables untuk Folder Tracking
        let currentFolderId = null;

        // MOBILE SIDEBAR TOGGLE
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        // --- SECURITY: HARDENED ADMIN CHECK ---
        async function checkAdmin() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) throw new Error("Unauthorized");

                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('role, full_name')
                    .eq('id', session.user.id)
                    .single();

                if (error || !profile) throw new Error("Profile Error");

                if (profile.role !== 'admin') {
                    await supabaseClient.auth.signOut();
                    throw new Error("Access Denied: Not an Admin");
                }

                document.getElementById('security-status').innerText = "Access Granted.";
                document.getElementById('admin-name-display').innerText = `Halo, ${profile.full_name}`;
                
                const overlay = document.getElementById('security-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);

                // Load Data Utama
                fetchUsers(); 
                fetchAnnouncements(); 
                fetchModules(); 
                initChart(); 
                initRealtimeDashboard(); 
                initCalendarRealtime(); 
                initDatabaseRealtime(); 
                initDigiSignRealtime(); 
                fetchDigiSignDocs(); 
                loadMySignature();
                
                // Load Folder Tracking
                fetchFolders();
                initTrackingRealtime();
                
                // INIT QUILL EDITORs
                initQuillEditors();

                setInterval(updatePresence, 60000); 
                updatePresence();

            } catch (err) {
                console.error("Security Breach Attempt:", err);
                document.body.innerHTML = '';
                
                await Swal.fire({
                    icon: 'error',
                    title: 'AKSES DITOLAK!',
                    text: 'Akun Anda tidak memiliki kualifikasi Administrator.',
                    confirmButtonText: 'Kembali',
                    confirmButtonColor: '#DB2777',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                
                window.location.href = 'index.html';
            }
        }

        function initQuillEditors() {
            const toolbarOptions = [
                [{ 'font': [] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'script': 'sub'}, { 'script': 'super' }],
                [{ 'header': 1 }, { 'header': 2 }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'align': [] }],
                ['link', 'image', 'video'],
                ['clean']
            ];

            quillBlast = new Quill('#editor-container', { theme: 'snow', modules: { toolbar: toolbarOptions }, placeholder: 'Tulis pesan email Anda di sini...' });
            quillAnnounce = new Quill('#announce-editor-container', { theme: 'snow', modules: { toolbar: toolbarOptions }, placeholder: 'Tulis isi pengumuman lengkap di sini (bisa gambar & link)...' });
        }

        async function updatePresence() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if(user) await supabaseClient.from('profiles').update({ last_seen: new Date().toISOString() }).eq('id', user.id);
        }

        function initDatabaseRealtime() { supabaseClient.channel('db-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => { fetchUsers(); Toast.fire({ icon: 'info', title: 'Data Peserta Diperbarui' }); }).subscribe(); }
        function initDigiSignRealtime() { supabaseClient.channel('digisign-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'digisign_documents' }, () => { fetchDigiSignDocs(); Toast.fire({ icon: 'info', title: 'Dokumen DigiSign Diperbarui' }); }).subscribe(); }


        /* =========================================================
           FOLDER BASED DAILY TRACKING LOGIC 
        ========================================================= */

        async function fetchFolders() {
            const { data, error } = await supabaseClient.from('tracking_folders').select('*').order('created_at', { ascending: true });
            const container = document.getElementById('view-folders');
            if (error) { console.error(error); return; }

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="col-span-full glass-card p-8 text-center text-gray-400 italic">Belum ada folder tracking. Klik "Tambah Folder" untuk memulai.</div>`;
                return;
            }

            container.innerHTML = data.map(folder => `
                <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 cursor-pointer hover:border-pink-300 hover:bg-pink-50 transition relative group" onclick="openFolder('${folder.id}', '${folder.name}')">
                    <button onclick="event.stopPropagation(); deleteFolder('${folder.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 lg:group-hover:opacity-100 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                    <i class="fa-solid fa-folder text-4xl text-yellow-400 drop-shadow-sm group-hover:scale-110 transition duration-300"></i>
                    <span class="font-bold text-gray-700 text-sm text-center truncate w-full">${folder.name}</span>
                </div>
            `).join('');
        }

        async function addFolder() {
            const { value: folderName } = await Swal.fire({
                title: 'Buat Folder Baru',
                input: 'text',
                inputPlaceholder: 'Nama Folder (Misal: Nama Tim / Divisi)',
                showCancelButton: true,
                confirmButtonText: 'Buat Folder',
                confirmButtonColor: '#DB2777',
                cancelButtonText: 'Batal',
                inputValidator: (value) => { if (!value) return 'Nama folder tidak boleh kosong!' }
            });

            if (folderName) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                Swal.showLoading();
                const { error } = await supabaseClient.from('tracking_folders').insert({ name: folderName, created_by: user.id });
                Swal.close();
                if (error) return Swal.fire('Error', error.message, 'error');
                Toast.fire({ icon: 'success', title: 'Folder dibuat' });
                fetchFolders();
            }
        }

        async function openFolder(id, name) {
            currentFolderId = id;
            document.getElementById('current-folder-title').innerText = name;
            document.getElementById('view-folders').classList.add('hidden');
            document.getElementById('view-folder-detail').classList.remove('hidden');
            document.getElementById('tracking-controls').classList.add('hidden');
            fetchProgress(id);
        }

        function closeFolder() {
            currentFolderId = null;
            document.getElementById('view-folders').classList.remove('hidden');
            document.getElementById('view-folder-detail').classList.add('hidden');
            document.getElementById('tracking-controls').classList.remove('hidden');
            fetchFolders();
        }

        async function fetchProgress(folderId) {
            const container = document.getElementById('progress-list');
            container.innerHTML = `<div class="text-center text-gray-400 text-xs py-4"><i class="fa-solid fa-spinner fa-spin"></i> Memuat progress...</div>`;

            const { data, error } = await supabaseClient.from('tracking_progress').select('*').eq('folder_id', folderId).order('created_at', { ascending: false });
            if (error) { container.innerHTML = `<div class="text-red-500 text-xs text-center py-4">Gagal memuat data.</div>`; return; }

            if (!data || data.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-gray-400 text-xs italic bg-gray-50 rounded-xl border border-dashed border-gray-200">Folder masih kosong. Tambahkan progress pertama!</div>`;
                return;
            }

            container.innerHTML = data.map(prog => `
                <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm hover:shadow-md transition group relative">
                    <button onclick="deleteProgress('${prog.id}', '${prog.folder_id}')" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 hidden md:block opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash text-xs"></i></button>
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-pink-500 to-rose-600 text-white flex items-center justify-center text-[10px] font-bold">${prog.author_name ? prog.author_name.charAt(0).toUpperCase() : 'A'}</div>
                        <span class="font-bold text-gray-800 text-xs">${prog.author_name || 'Admin'}</span>
                        <span class="text-[10px] text-gray-400"><i class="fa-regular fa-clock"></i> ${new Date(prog.created_at).toLocaleString('id-ID', {day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <p class="text-sm text-gray-600 whitespace-pre-line leading-relaxed">${prog.content}</p>
                    <button onclick="deleteProgress('${prog.id}', '${prog.folder_id}')" class="md:hidden mt-3 text-[10px] text-red-500 font-bold bg-red-50 px-2 py-1 rounded inline-block">Hapus</button>
                </div>
            `).join('');
        }

        async function addProgress() {
            const { value: content } = await Swal.fire({
                title: 'Tambah Progress',
                input: 'textarea',
                inputPlaceholder: 'Tuliskan progress kerja atau laporan harian kamu di sini...',
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                confirmButtonColor: '#DB2777',
                cancelButtonText: 'Batal',
                customClass: { input: 'h-32 text-sm' },
                inputValidator: (value) => { if (!value) return 'Progress tidak boleh kosong!' }
            });

            if (content && currentFolderId) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                const { data: profile } = await supabaseClient.from('profiles').select('full_name').eq('id', user.id).single();
                const authorName = profile ? profile.full_name : 'Admin';

                Swal.showLoading();
                const { error } = await supabaseClient.from('tracking_progress').insert({
                    folder_id: currentFolderId,
                    content: content,
                    created_by: user.id,
                    author_name: authorName
                });
                Swal.close();

                if (error) return Swal.fire('Error', error.message, 'error');
                Toast.fire({ icon: 'success', title: 'Progress disimpan' });
                fetchProgress(currentFolderId);
            }
        }

        async function deleteFolder(id) {
            if ((await Swal.fire({title:'Hapus Folder?', text:'Semua isi progress di dalamnya akan ikut terhapus permanen.', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'Ya, hapus!'})).isConfirmed) {
                await supabaseClient.from('tracking_folders').delete().eq('id', id);
                Toast.fire({ icon: 'success', title: 'Folder dihapus' });
                fetchFolders();
            }
        }

        async function deleteProgress(progId, folderId) {
            if ((await Swal.fire({title:'Hapus Progress?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33'})).isConfirmed) {
                await supabaseClient.from('tracking_progress').delete().eq('id', progId);
                Toast.fire({ icon: 'success', title: 'Progress dihapus' });
                fetchProgress(folderId);
            }
        }

        function initTrackingRealtime() {
            supabaseClient.channel('tracking-folders-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'tracking_folders' }, () => {
                if (!currentFolderId) fetchFolders();
            }).subscribe();
            
            supabaseClient.channel('tracking-progress-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'tracking_progress' }, (payload) => {
                if (currentFolderId && (payload.new?.folder_id === currentFolderId || payload.old?.folder_id === currentFolderId)) {
                    fetchProgress(currentFolderId);
                }
            }).subscribe();
        }

        /* =========================================================
           END LOGIC FOLDER BASED TRACKING
        ========================================================= */

        // --- EMAIL BLAST LOGIC ---
        function updateRecipientCount() {
            const val = document.getElementById('blast-recipients').value;
            const emails = val.split(/[\n,]+/).map(e => e.trim()).filter(e => e !== "");
            document.getElementById('recipient-count').innerText = `${emails.length} Email`;
            return emails;
        }

        function processExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                let extractedEmails = [];
                const emailRegex = /([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi;

                jsonData.forEach(row => {
                    row.forEach(cell => {
                        if (typeof cell === 'string') {
                            const matches = cell.match(emailRegex);
                            if (matches) {
                                extractedEmails.push(...matches);
                            }
                        }
                    });
                });

                extractedEmails = [...new Set(extractedEmails)];

                const textArea = document.getElementById('blast-recipients');
                const currentText = textArea.value.trim();
                
                if (currentText.length > 0) {
                    textArea.value = currentText + ",\n" + extractedEmails.join(",\n");
                } else {
                    textArea.value = extractedEmails.join(",\n");
                }

                updateRecipientCount();
                Toast.fire({ icon: 'success', title: `${extractedEmails.length} Email ditambahkan dari Excel` });
                
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        async function startBlast() {
            const subject = document.getElementById('blast-subject').value;
            const body = quillBlast.root.innerHTML; 
            const emails = updateRecipientCount();

            const SENDER_EMAIL = "admin@ylos.site"; 
            const SENDER_NAME = "YLOS Official";    
            
            const isBodyEmpty = quillBlast.getText().trim().length === 0 && body.indexOf('<img') === -1;

            if (!subject || isBodyEmpty) return Swal.fire('Error', 'Subject dan Isi pesan harus diisi', 'error');
            if (emails.length === 0) return Swal.fire('Error', 'Daftar penerima kosong', 'error');

            const result = await Swal.fire({
                title: 'Kirim Blast Pro?',
                text: `Mengirim ${emails.length} email via Supabase Edge Function (Resend).`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Gas, Kirim!',
                confirmButtonColor: '#DB2777'
            });

            if (!result.isConfirmed) return;

            const btn = document.getElementById('btn-blast');
            const progressContainer = document.getElementById('blast-progress-container');
            const progressBar = document.getElementById('blast-bar');
            const statusText = document.getElementById('blast-percent');
            const detailText = document.getElementById('blast-detail');

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            progressContainer.classList.remove('hidden');

            let successCount = 0;
            let failCount = 0;
            const total = emails.length;

            for (let i = 0; i < total; i++) {
                const email = emails[i];
                const percent = Math.round(((i + 1) / total) * 100);
                progressBar.style.width = `${percent}%`;
                statusText.innerText = `${percent}%`;
                detailText.innerText = `Mengirim ke: ${email}...`;

                try {
                    const { data, error } = await supabaseClient.functions.invoke('resend', {
                        body: { email: email, subject: subject, body: body, sender_name: SENDER_NAME, sender_email: SENDER_EMAIL }
                    });
                    if (error) throw error;
                    successCount++;
                } catch (e) {
                    console.error(`[GAGAL] ${email}:`, e);
                    failCount++;
                }
                await new Promise(r => setTimeout(r, 1000));
            }

            progressBar.style.width = '100%';
            statusText.innerText = '100%';
            let msg = `Selesai! ${successCount} Terkirim.`;
            if (failCount > 0) msg += ` (${failCount} Gagal)`;
            detailText.innerText = msg;

            await new Promise(r => setTimeout(r, 500));
            
            Swal.fire({
                icon: failCount === 0 ? 'success' : 'warning',
                title: 'Blast Selesai',
                text: msg
            });

            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- DIGISIGN LOGIC ---
        async function updateDigiSignStats() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { count: inbox } = await supabaseClient.from('digisign_documents').select('*', {count:'exact', head:true}).eq('signer_id', user.id).eq('status', 'pending');
            const { count: sent } = await supabaseClient.from('digisign_documents').select('*', {count:'exact', head:true}).eq('requester_id', user.id);
            const { count: done } = await supabaseClient.from('digisign_documents').select('*', {count:'exact', head:true}).eq('status', 'signed');
            document.getElementById('ds-need-sign').innerText = inbox || 0; document.getElementById('ds-sent-personal').innerText = sent || 0; document.getElementById('ds-completed-global').innerText = done || 0;
            const badge = document.getElementById('badge-inbox'); badge.innerText = inbox || 0; inbox > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
        }
        async function fetchDigiSignDocs(filter = 'inbox') {
            updateDigiSignStats();
            document.querySelectorAll('.ds-tab').forEach(b => { b.classList.remove('active'); });
            document.getElementById(filter === 'inbox' ? 'tab-inbox' : filter === 'sent' ? 'tab-sent' : 'tab-completed').classList.add('active');
            const { data: { user } } = await supabaseClient.auth.getUser();
            let query = supabaseClient.from('digisign_documents').select('*, requester:requester_id(full_name), signer:signer_id(full_name)');
            if(filter === 'inbox') query = query.eq('signer_id', user.id).eq('status', 'pending');
            else if(filter === 'sent') query = query.eq('requester_id', user.id);
            else if(filter === 'completed') query = query.eq('status', 'signed');
            const { data } = await query.order('created_at', {ascending: false});
            const tbody = document.getElementById('digisign-list'); tbody.innerHTML = '';
            if(!data || data.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400 italic">Tidak ada dokumen.</td></tr>`; return; }
            data.forEach(doc => {
                let tracking = `<div class="flex flex-col md:flex-row items-start md:items-center gap-2 text-xs bg-gray-50 w-fit px-3 py-1 rounded-full"><span class="font-bold text-blue-600">${doc.requester?.full_name || 'Admin'}</span> <i class="fa-solid fa-arrow-right text-gray-400 text-[10px] hidden md:inline"></i> <span class="font-bold text-pink-600">${doc.signer?.full_name || 'Admin'}</span></div>`;
                let btn = '';
                if(filter === 'inbox') btn = `<button onclick="openSigningRoom('${doc.id}', '${doc.filename}')" class="bg-pink-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-pink-700 shadow-sm transition transform hover:-translate-y-0.5 whitespace-nowrap">Tanda Tangani</button>`;
                else if(doc.status === 'signed') btn = `<button onclick="downloadSignedDoc('${doc.signed_file_path.split('/').pop()}')" class="text-green-600 font-bold text-xs hover:underline flex items-center gap-1 mx-auto bg-green-50 px-3 py-1 rounded-lg border border-green-200"><i class="fa-solid fa-download"></i> Unduh</button>`;
                else btn = `<span class="text-gray-400 text-xs font-mono bg-gray-50 px-2 py-1 rounded">Menunggu...</span>`;
                let status = doc.status === 'signed' ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-green-200">Selesai</span>' : '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase border border-yellow-200">Pending</span>';
                tbody.innerHTML += `<tr class="hover:bg-gray-50 transition"><td class="px-6 py-4 font-medium text-gray-800"><div class="truncate max-w-[150px] md:max-w-none" title="${doc.filename}">${doc.filename}</div></td><td class="px-6 py-4">${tracking}</td><td class="px-6 py-4">${status}</td><td class="px-6 py-4 text-center">${btn}</td></tr>`;
            });
        }
        async function downloadSignedDoc(fileName) {
            const { data, error } = await supabaseClient.storage.from('digisign-files').download('signed/' + fileName);
            if (error) return Toast.fire({ icon: 'error', title: 'Gagal Download' });
            const url = window.URL.createObjectURL(data); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove(); Toast.fire({ icon: 'success', title: 'Mendownload...' });
        }
        async function openUploadModal() {
            const { data: admins } = await supabaseClient.from('profiles').select('id, full_name').eq('role', 'admin');
            const { data: { user } } = await supabaseClient.auth.getUser();
            const opts = admins.filter(a => a.id !== user.id).map(a => `<option value="${a.id}">${a.full_name}</option>`).join('');
            const { value: f } = await Swal.fire({ title: 'Upload Dokumen', html: `<div class="border-2 border-dashed border-gray-300 bg-gray-50 p-6 rounded-xl text-center cursor-pointer hover:border-pink-400 hover:bg-pink-50 transition" onclick="document.getElementById('up-file').click()"><i class="fa-solid fa-cloud-arrow-up text-3xl text-gray-300 mb-2"></i><p class="text-sm font-bold text-gray-500" id="file-label">Klik untuk pilih PDF</p><input type="file" id="up-file" class="hidden" accept="application/pdf" onchange="document.getElementById('file-label').innerText = this.files[0].name"></div><div class="mt-4 text-left"><label class="text-xs font-bold text-gray-500 uppercase">Tanda Tangan Oleh:</label><select id="up-signer" class="w-full mt-1 p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm">${opts}</select></div>`, showCancelButton: true, confirmButtonText: 'Kirim Request', confirmButtonColor: '#DB2777', preConfirm: () => { const file = document.getElementById('up-file').files[0]; if(!file) Swal.showValidationMessage("Pilih file PDF dulu!"); return { file: file, signer: document.getElementById('up-signer').value } } });
            if(f) {
                Swal.fire({title:'Mengirim...', didOpen:()=>Swal.showLoading()}); const fname = `${Date.now()}_${f.file.name}`;
                await supabaseClient.storage.from('digisign-files').upload(fname, f.file); const {data:{publicUrl}} = supabaseClient.storage.from('digisign-files').getPublicUrl(fname);
                await supabaseClient.from('digisign_documents').insert({ filename: fname, file_path: publicUrl, signer_id: f.signer, requester_id: user.id });
                Swal.fire({ icon: 'success', title: 'Terkirim!', text: 'Request tanda tangan telah dikirim.', timer: 2000, showConfirmButton: false}); fetchDigiSignDocs();
            }
        }

        async function changePdfPage(offset) {
            const newPage = currentPageNum + offset;
            if (newPage >= 1 && newPage <= totalPdfPages) {
                currentPageNum = newPage;
                const canvas = document.getElementById('the-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = "20px Arial";
                ctx.fillText("Loading page...", 50, 50);
                await renderCurrentPage();
            }
        }

        // --- SIGNING ROOM ---
        function cloneBuffer(buffer) { const dst = new ArrayBuffer(buffer.byteLength); new Uint8Array(dst).set(new Uint8Array(buffer)); return dst; }
        async function openSigningRoom(docId, fileName) {
            currentDocId = docId;
            document.getElementById('doc-name-display').innerText = fileName;
            document.getElementById('signing-modal').classList.remove('hidden');
            
            Swal.fire({title: 'Memuat...', didOpen: () => Swal.showLoading(), backdrop: false, showConfirmButton: false});
            await new Promise(r => setTimeout(r, 500));

            try {
                const sigCanvas = document.getElementById('signature-pad'); 
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                sigCanvas.width = sigCanvas.offsetWidth * ratio; 
                sigCanvas.height = sigCanvas.offsetHeight * ratio; 
                sigCanvas.getContext("2d").scale(ratio, ratio);
                
                if(signaturePad) signaturePad.off(); 
                signaturePad = new SignaturePad(sigCanvas); 
                signaturePad.clear();

                const { data, error } = await supabaseClient.storage.from('digisign-files').download(fileName); 
                if (error) throw error; 
                pdfBytes = await data.arrayBuffer();

                const loadingTask = pdfjsLib.getDocument({data: cloneBuffer(pdfBytes)});
                currentPdfObject = await loadingTask.promise;
                totalPdfPages = currentPdfObject.numPages;
                
                currentPageNum = 1;
                await renderCurrentPage();

                const dragEl = document.getElementById('drag-signature'); 
                dragEl.classList.add('hidden'); 
                dragEl.style.top = '100px'; 
                dragEl.style.left = '100px'; 
                initDraggable(dragEl); 
                
                Swal.close();
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
        }
        function useSignature() {
            if (signaturePad && signaturePad.isEmpty()) return Toast.fire({ icon: 'warning', title: 'Tanda tangan dulu dong!' });
            const dataUrl = signaturePad.toDataURL(); document.getElementById('drag-sig-img').src = dataUrl; document.getElementById('drag-signature').classList.remove('hidden');
            Toast.fire({ icon: 'success', title: 'Geser & Resize Tanda Tangan!' });
            if(!mySavedSignature) { Swal.fire({ title: 'Simpan Tanda Tangan?', text: 'Untuk penggunaan berikutnya.', icon: 'question', showCancelButton: true, confirmButtonText: 'Ya', cancelButtonText: 'Nanti' }).then((res) => { if(res.isConfirmed) saveMySignature(dataUrl); }); }
        }
        function initDraggable(el) {
            let isDragging = false, startX, startY, initialLeft, initialTop;
            const handleStart = (clientX, clientY) => {
                if(clientX > el.getBoundingClientRect().right - 15 && clientY > el.getBoundingClientRect().bottom - 15) return; 
                isDragging = true; startX = clientX; startY = clientY; 
                initialLeft = el.offsetLeft; initialTop = el.offsetTop; 
                el.style.cursor = 'grabbing'; 
            }
            const handleMove = (clientX, clientY, e) => {
                if(!isDragging) return; if(e) e.preventDefault();
                el.style.left = `${initialLeft + clientX - startX}px`; 
                el.style.top = `${initialTop + clientY - startY}px`; 
            }
            const handleEnd = () => { isDragging = false; el.style.cursor = 'grab'; };
            el.onmousedown = (e) => handleStart(e.clientX, e.clientY);
            window.onmousemove = (e) => handleMove(e.clientX, e.clientY, e);
            window.onmouseup = handleEnd;
            el.ontouchstart = (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY);
            window.ontouchmove = (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY, e);
            window.ontouchend = handleEnd;
        }
        async function saveSignedDocument() {
            const dragEl = document.getElementById('drag-signature'); 
            if(dragEl.classList.contains('hidden')) return Toast.fire({ icon: 'warning', title: 'Letakkan tanda tangan di dokumen!' });
            
            Swal.fire({title: 'Memproses...', didOpen: () => Swal.showLoading()});
            
            try {
                const pdfDoc = await PDFLib.PDFDocument.load(cloneBuffer(pdfBytes));
                const pages = pdfDoc.getPages();
                const activePageIdx = currentPageNum - 1; 
                const activePage = pages[activePageIdx];

                const imgEl = document.getElementById('drag-sig-img'); 
                const sigImage = await pdfDoc.embedPng(imgEl.src);
                const canvas = document.getElementById('the-canvas');
                
                const canvasRect = canvas.getBoundingClientRect();
                const sigRect = dragEl.getBoundingClientRect();
                const relativeX = sigRect.left - canvasRect.left;
                const relativeY = sigRect.top - canvasRect.top;

                const pdfWidth = activePage.getWidth();
                const pdfHeight = activePage.getHeight();
                const scaleX = pdfWidth / canvas.width;
                const scaleY = pdfHeight / canvas.height;
                
                const x = relativeX * scaleX;
                const y = pdfHeight - ((relativeY + dragEl.offsetHeight) * scaleY);
                const width = dragEl.offsetWidth * scaleX;
                const height = dragEl.offsetHeight * scaleY;
                
                activePage.drawImage(sigImage, { x, y, width, height });

                const pdfBytesSigned = await pdfDoc.save();
                const signedFile = new File([new Blob([pdfBytesSigned], { type: 'application/pdf' })], `signed_${Date.now()}.pdf`, { type: 'application/pdf' });
                const { error: upErr } = await supabaseClient.storage.from('digisign-files').upload(`signed/${signedFile.name}`, signedFile); 
                if(upErr) throw upErr;
                
                await supabaseClient.from('digisign_documents').update({ status: 'signed', signed_file_path: `signed/${signedFile.name}`, signed_at: new Date() }).eq('id', currentDocId);
                
                closeSigningModal(); 
                fetchDigiSignDocs(); 
                Swal.fire({ icon: 'success', title: 'Berhasil!', text: `Dokumen ditandatangani di Halaman ${currentPageNum}.`, showConfirmButton: false, timer: 2000 });
            } catch (err) { Swal.fire('Gagal', err.message, 'error'); }
        }
        function closeSigningModal() { document.getElementById('signing-modal').classList.add('hidden'); } function clearPad() { if(signaturePad) signaturePad.clear(); }
        async function loadMySignature() { const { data: { user } } = await supabaseClient.auth.getUser(); const { data } = await supabaseClient.from('admin_signatures').select('signature_data').eq('admin_id', user.id).single(); const container = document.getElementById('saved-sig-container'); if (data && data.signature_data) { mySavedSignature = data.signature_data; container.innerHTML = `<div onclick="useSavedSignature()" class="bg-white border-2 border-gray-200 rounded-xl p-2 cursor-pointer hover:border-pink-500 hover:shadow-md transition group relative h-24 flex items-center justify-center"><img src="${data.signature_data}" class="max-h-full max-w-full object-contain"><div class="absolute inset-0 bg-pink-600/10 opacity-0 group-hover:opacity-100 transition rounded-xl flex items-center justify-center backdrop-blur-sm"><span class="bg-white text-pink-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm">Pakai Ini</span></div></div><div class="text-center mt-2"><button onclick="deleteMySignature()" class="text-xs text-red-400 hover:text-red-600 underline">Hapus</button></div>`; } else { container.innerHTML = `<div class="text-center py-4 text-gray-400 text-xs italic bg-gray-50 rounded-xl border border-gray-100 border-dashed">Belum ada.</div>`; mySavedSignature = null; } }
        async function saveMySignature(dataUrl) { const { data: { user } } = await supabaseClient.auth.getUser(); await supabaseClient.from('admin_signatures').upsert({ admin_id: user.id, signature_data: dataUrl }); loadMySignature(); Toast.fire({ icon: 'success', title: 'Tanda tangan disimpan' }); }
        async function deleteMySignature() { const { data: { user } } = await supabaseClient.auth.getUser(); await supabaseClient.from('admin_signatures').delete().eq('admin_id', user.id); loadMySignature(); }
        function useSavedSignature() { if(!mySavedSignature) return; document.getElementById('drag-sig-img').src = mySavedSignature; document.getElementById('drag-signature').classList.remove('hidden'); Toast.fire({ icon: 'success', title: 'Tanda tangan dimuat' }); }

        // --- DASHBOARD & USER LOGIC ---
        function switchTab(tabId) { 
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active')); 
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active')); 
            document.getElementById('section-' + tabId).classList.add('active'); 
            document.getElementById('menu-' + tabId).classList.add('active'); 
            if (tabId === 'calendar') setTimeout(() => { !calendarInstance ? initCalendar() : calendarInstance.render(); }, 100); 
            
            if(window.innerWidth < 768) {
                const sidebar = document.getElementById('main-sidebar');
                const backdrop = document.getElementById('mobile-backdrop');
                if (!sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.add('-translate-x-full');
                    backdrop.classList.add('hidden');
                }
            }
        }

        async function renderCurrentPage() {
            if (!currentPdfObject) return;
            document.getElementById('page-indicator').innerText = `Page ${currentPageNum}/${totalPdfPages}`;
            document.getElementById('btn-prev-page').disabled = currentPageNum <= 1;
            document.getElementById('btn-next-page').disabled = currentPageNum >= totalPdfPages;
            const page = await currentPdfObject.getPage(currentPageNum);
            const canvas = document.getElementById('the-canvas');
            const ctx = canvas.getContext('2d');
            const containerWidth = document.getElementById('pdf-wrapper').parentElement.clientWidth - 40;
            const viewport = page.getViewport({scale: 1.0});
            const scale = containerWidth < viewport.width ? containerWidth / viewport.width : 1.0;
            const scaledViewport = page.getViewport({scale: scale});
            canvas.height = scaledViewport.height; 
            canvas.width = scaledViewport.width;
            await page.render({canvasContext: ctx, viewport: scaledViewport}).promise;
        }

        async function fetchUsers() { const {data} = await supabaseClient.from('profiles').select('*').order('created_at', { ascending: false }); allUsers = data||[]; renderTable(allUsers); renderVerificationList(allUsers); document.getElementById('stat-total').innerText = allUsers.length; document.getElementById('stat-lunas').innerText = allUsers.filter(u => u.payment_status === 'Lunas').length; document.getElementById('stat-pending').innerText = allUsers.filter(u => u.payment_status !== 'Lunas').length; document.getElementById('table-total').innerText = allUsers.length; }
        
        function timeAgo(dateString) {
            if(!dateString) return '<span class="text-gray-400 text-xs italic">-</span>';
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return '<span class="text-green-600 text-xs font-bold flex items-center justify-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online</span>';
            
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `<span class="text-gray-500 text-xs">${minutes} mnt lalu</span>`;
            
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `<span class="text-gray-500 text-xs">${hours} jam lalu</span>`;
            
            return `<span class="text-gray-400 text-xs">${date.toLocaleDateString('id-ID')}</span>`;
        }

        function renderTable(users) { 
            document.getElementById('userTableBody').innerHTML = users.map(u => { 
                const badge = u.payment_status === 'Lunas' ? '<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">Lunas</span>' : '<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">Pending</span>'; 
                const action = u.payment_status === 'Lunas' ? `<button onclick="updateStatus('${u.id}', 'Pending')" class="text-xs bg-yellow-50 text-yellow-600 px-3 py-1 rounded-lg border border-yellow-200 hover:bg-yellow-100 transition font-bold">Batalkan</button>` : `<button onclick="updateStatus('${u.id}', 'Lunas')" class="text-xs bg-green-50 text-green-600 px-3 py-1 rounded-lg border border-green-200 hover:bg-green-100 transition font-bold">Verifikasi</button>`; 
                const lastSeen = timeAgo(u.last_seen);
                
                return `<tr class="hover:scale-[1.01] transition duration-200">
                    <td class="p-4 font-bold text-gray-800">${u.full_name || '-'}</td>
                    <td class="p-4 text-gray-500">${u.school || '-'}</td>
                    <td class="p-4 text-xs font-mono text-gray-500">${u.phone || '-'}</td>
                    <td class="p-4">${badge}</td>
                    <td class="p-4 text-center">${lastSeen}</td>
                    <td class="p-4 text-center flex gap-2 justify-center">${action}<button onclick="deleteUser('${u.id}')" class="text-red-400 hover:text-red-600 p-2 rounded hover:bg-red-50 transition"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`; 
            }).join(''); 
        }
        
        function filterVerification() {
            const term = document.getElementById('searchVerification').value.toLowerCase();
            const filtered = allUsers.filter(u => 
                (u.full_name && u.full_name.toLowerCase().includes(term)) || 
                (u.email && u.email.toLowerCase().includes(term))
            );
            renderVerificationList(filtered);
        }

        function renderVerificationList(users) { 
            document.getElementById('verification-list').innerHTML = users.map(u => { 
                let statusLogin = u.email ? `<span class="text-green-500 text-[10px] font-bold bg-green-50 px-3 py-1 rounded-full">â— Aktif</span>` : `<span class="text-gray-400 text-[10px] bg-gray-50 px-3 py-1 rounded-full">â—‹ Belum</span>`; 
                let regStatus = u.email 
                    ? `<span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-bold border border-blue-200">Berhasil Mendaftar</span>` 
                    : `<span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-[10px] font-bold border border-orange-200">Menunggu Konfirmasi</span>`;

                return `<tr>
                    <td class="p-4 font-bold text-gray-700">${u.full_name}</td>
                    <td class="p-4 text-xs text-blue-600 font-mono">${u.email}</td>
                    <td class="p-4 text-xs font-mono">${u.phone}</td>
                    <td class="p-4 text-center">${regStatus}</td>
                    <td class="p-4 text-center">${statusLogin}</td>
                    <td class="p-4 text-center"><button onclick="resendEmail('${u.email}')" class="text-xs bg-gray-900 text-white px-4 py-1.5 rounded-lg shadow hover:bg-black transition flex items-center gap-2 mx-auto whitespace-nowrap"><i class="fa-regular fa-paper-plane"></i> Kirim Link</button></td>
                </tr>`; 
            }).join(''); 
        }
        
        async function updateStatus(id, status) { Swal.showLoading(); await supabaseClient.from('profiles').update({ payment_status: status }).eq('id', id); Swal.close(); fetchUsers(); Toast.fire({ icon: 'success', title: 'Status diupdate' }); }
        async function deleteUser(id) { if((await Swal.fire({title:'Hapus Data?', text:'Tindakan ini permanen', icon:'warning', showCancelButton:true})).isConfirmed) { await supabaseClient.from('profiles').delete().eq('id', id); fetchUsers(); Toast.fire({ icon: 'success', title: 'Data dihapus' }); } }
        
        async function resendEmail(email) { 
            Swal.showLoading(); 
            const { error } = await supabaseClient.auth.resend({ type: 'signup', email: email, options: { emailRedirectTo: window.location.origin + '/index.html' } }); 
            if (error) {
                if(error.message.includes("already")) {
                    const { error: magicLinkError } = await supabaseClient.auth.signInWithOtp({ email: email, options: { emailRedirectTo: window.location.origin + '/index.html' } });
                    if(magicLinkError) { Swal.fire('Gagal', magicLinkError.message, 'error'); } else { Swal.fire({ icon: 'success', title: 'Link Login Terkirim!', text: `User ongoing. Link login dikirim ke ${email}`, showConfirmButton: false, timer: 2000 }); }
                } else { Swal.fire('Gagal', error.message, 'error'); }
            } else { Swal.fire({ icon: 'success', title: 'Verifikasi Terkirim!', text: `Link verifikasi dikirim ke ${email}`, showConfirmButton: false, timer: 2000 }); }
        }
        
        function filterTable() { 
            const term = document.getElementById('searchInput').value.toLowerCase(); 
            const filteredUsers = allUsers.filter(u => {
                const name = (u.full_name || '').toLowerCase();
                const school = (u.school || '').toLowerCase();
                return name.includes(term) || school.includes(term);
            });
            renderTable(filteredUsers); 
        }

        // --- CALENDAR (GOOGLE STYLE) ---
        function initCalendar() { 
            const calendarEl = document.getElementById('calendar'); 
            calendarInstance = new FullCalendar.Calendar(calendarEl, { 
                initialView: 'dayGridMonth', 
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' }, 
                locale: 'id', editable: true, selectable: true, selectMirror: true, dayMaxEvents: true, height: 'auto',
                events: async (info, success, failure) => { 
                    const { data, error } = await supabaseClient.from('admin_calendar').select('*'); 
                    if (error) failure(error); 
                    else success(data.map(evt => ({ id: evt.id, title: evt.title, start: evt.start_time, end: evt.end_time, description: evt.description }))); 
                }, 
                select: async (info) => { 
                    let adjustedEndDate = new Date(info.end);
                    if (info.allDay) adjustedEndDate.setDate(adjustedEndDate.getDate() - 0);
                    const displayEndDate = adjustedEndDate.toISOString().split('T')[0];

                    const { value: f } = await Swal.fire({ 
                        title: 'Tambah Jadwal',
                        html: `<div class="swal-cal-container"><div class="swal-cal-group"><label class="swal-cal-label">Judul Kegiatan</label><input id="cal-title" class="swal2-input swal-cal-input" placeholder="Contoh: Meeting Koordinasi"></div><div class="swal-cal-group"><label class="swal-cal-label">Detail</label><textarea id="cal-desc" class="swal2-textarea swal-cal-input" style="height: 80px" placeholder="Tambahkan deskripsi..."></textarea></div><div class="swal-cal-row"><div class="swal-cal-group"><label class="swal-cal-label">Mulai</label><input id="cal-start" type="datetime-local" class="swal2-input swal-cal-input" value="${info.startStr}T09:00"></div><div class="swal-cal-group"><label class="swal-cal-label">Selesai</label><input id="cal-end" type="datetime-local" class="swal2-input swal-cal-input" value="${displayEndDate}T17:00"></div></div></div>`, 
                        focusConfirm: false, showCancelButton: true, confirmButtonText: 'Simpan Jadwal', confirmButtonColor: '#DB2777', cancelButtonText: 'Batal',
                        customClass: { confirmButton: 'btn-press rounded-xl px-6', cancelButton: 'rounded-xl' },
                        preConfirm: () => {
                            const title = document.getElementById('cal-title').value;
                            if (!title) { Swal.showValidationMessage('Judul tidak boleh kosong!'); return false; }
                            return { title: title, description: document.getElementById('cal-desc').value, start: document.getElementById('cal-start').value, end: document.getElementById('cal-end').value }
                        } 
                    }); 
                    if (f) { 
                        await supabaseClient.from('admin_calendar').insert({ title: f.title, description: f.description, start_time: f.start, end_time: f.end }); 
                        calendarInstance.refetchEvents(); Toast.fire({ icon: 'success', title: 'Jadwal Berhasil Ditambahkan' }); 
                    }
                    calendarInstance.unselect();
                }, 
                eventClick: async (info) => {
                    const evt = info.event; 
                    if ((await Swal.fire({ 
                        title: evt.title, 
                        html: `<div class="text-left text-sm text-gray-600"><p class="mb-2">${evt.extendedProps.description || 'Tidak ada deskripsi'}</p><hr class="my-2"><p class="text-[10px] font-bold text-gray-400 uppercase">Waktu:</p><p>${evt.start.toLocaleString('id-ID')}</p></div>`, 
                        showDenyButton: true, confirmButtonText: 'Tutup', denyButtonText: 'Hapus Jadwal', confirmButtonColor: '#334155', denyButtonColor: '#DC2626' 
                    })).isDenied) { 
                        await supabaseClient.from('admin_calendar').delete().eq('id', evt.id); evt.remove(); Toast.fire({ icon: 'success', title: 'Jadwal Dihapus' }); 
                    } 
                }
            }); 
            calendarInstance.render(); 
        }
        function initCalendarRealtime() { supabaseClient.channel('calendar-sync').on('postgres_changes', { event: '*', schema: 'public', table: 'admin_calendar' }, () => { if(calendarInstance) calendarInstance.refetchEvents(); }).subscribe(); }
        
        // --- ANNOUNCEMENTS LOGIC ---
        async function fetchAnnouncements() { 
            const { data } = await supabaseClient.from('announcements').select('*').order('order_index', {ascending: true}); 
            
            document.getElementById('announcement-list').innerHTML = data.map(item => `
                <div data-id="${item.id}" class="glass-card p-4 flex items-center gap-4 group draggable-item cursor-move mb-3">
                    <i class="fa-solid fa-grip-vertical text-gray-300 group-hover:text-pink-400 transition"></i>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-800 text-sm truncate">${item.title}</h4>
                        <div class="text-xs text-gray-500 truncate opacity-70">Klik edit untuk lihat isi...</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editAnnounce('${item.id}')" class="text-blue-400 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="delAnnounce('${item.id}')" class="text-gray-300 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join(''); 
            
            new Sortable(document.getElementById('announcement-list'), { 
                animation: 200, 
                handle: '.fa-grip-vertical', 
                delay: 100, 
                delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: async (evt) => { await updateOrder(evt.to, 'announcements'); Toast.fire({ icon: 'success', title: 'Urutan Diperbarui' }); } 
            });
        }
        
        async function saveAnnounce() {
            const title = document.getElementById('announce-title').value;
            const content = quillAnnounce.root.innerHTML;
            
            if(!title || quillAnnounce.getText().trim().length === 0 && content.indexOf('<img') === -1) {
                return Toast.fire({ icon: 'warning', title: 'Judul dan Konten wajib diisi' });
            }

            if(editingAnnounceId) {
                await supabaseClient.from('announcements').update({ title, content }).eq('id', editingAnnounceId);
                Toast.fire({ icon: 'success', title: 'Pengumuman Diperbarui' });
            } else {
                await supabaseClient.from('announcements').insert({ title, content });
                Toast.fire({ icon: 'success', title: 'Pengumuman Diposting' });
            }

            cancelEditAnnounce();
            fetchAnnouncements();
        }

        async function editAnnounce(id) {
            Swal.showLoading();
            const { data } = await supabaseClient.from('announcements').select('*').eq('id', id).single();
            Swal.close();
            
            if(data) {
                editingAnnounceId = id;
                document.getElementById('announce-title').value = data.title;
                quillAnnounce.root.innerHTML = data.content;
                
                document.getElementById('btn-save-announce').innerText = "Simpan Perubahan";
                document.getElementById('btn-cancel-announce').classList.remove('hidden');
                
                document.getElementById('section-announcements').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function cancelEditAnnounce() {
            editingAnnounceId = null;
            document.getElementById('announce-title').value = '';
            quillAnnounce.setText('');
            document.getElementById('btn-save-announce').innerText = "Posting";
            document.getElementById('btn-cancel-announce').classList.add('hidden');
        }

        async function delAnnounce(id) { 
            if((await Swal.fire({title:'Hapus Pengumuman?', icon:'warning', showCancelButton:true})).isConfirmed) {
                await supabaseClient.from('announcements').delete().eq('id', id); 
                fetchAnnouncements(); 
                Toast.fire({ icon: 'success', title: 'Dihapus' }); 
            }
        }


        // --- MODULES LOGIC ---
        async function fetchModules() { 
            const { data } = await supabaseClient.from('modules').select('*').order('order_index', {ascending: true}); 
            
            document.getElementById('module-list').innerHTML = data.map(mod => `
                <div data-id="${mod.id}" class="glass-card p-4 flex items-center gap-4 group draggable-item cursor-move mb-3">
                    <i class="fa-solid fa-grip-vertical text-gray-300 group-hover:text-pink-400 transition"></i>
                    <div class="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-500 flex-shrink-0"><i class="fa-solid fa-file-alt"></i></div>
                    <div class="flex-1 min-w-0">
                        <h4 class="font-bold text-gray-800 text-sm truncate">${mod.title}</h4>
                        <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded font-bold uppercase">${mod.category}</span>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="editModule('${mod.id}')" class="text-blue-400 hover:text-blue-600 p-2 rounded-lg hover:bg-blue-50 transition"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="delModule('${mod.id}')" class="text-gray-300 hover:text-red-500 p-2 rounded-lg hover:bg-red-50 transition"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join(''); 
            
            new Sortable(document.getElementById('module-list'), { 
                animation: 200, 
                handle: '.fa-grip-vertical',
                delay: 100, 
                delayOnTouchOnly: true,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: async (evt) => { await updateOrder(evt.to, 'modules'); Toast.fire({ icon: 'success', title: 'Urutan Materi Diupdate' }); } 
            });
        }
        
        async function saveModule() {
            const title = document.getElementById('mod-title').value;
            const link_url = document.getElementById('mod-link').value;
            const category = document.getElementById('mod-category').value;
            const is_premium = document.getElementById('mod-premium').value === 'true';

            if(!title || !link_url) return Toast.fire({icon: 'warning', title: 'Lengkapi Data Materi'});

            if(editingModuleId) {
                await supabaseClient.from('modules').update({ title, link_url, category, is_premium }).eq('id', editingModuleId);
                Toast.fire({ icon: 'success', title: 'Materi Diperbarui' });
            } else {
                await supabaseClient.from('modules').insert({ title, link_url, category, is_premium });
                Toast.fire({ icon: 'success', title: 'Materi Diupload' });
            }
            
            cancelEditModule();
            fetchModules();
        }

        async function editModule(id) {
             Swal.showLoading();
            const { data } = await supabaseClient.from('modules').select('*').eq('id', id).single();
            Swal.close();
            
            if(data) {
                editingModuleId = id;
                document.getElementById('mod-title').value = data.title;
                document.getElementById('mod-link').value = data.link_url;
                document.getElementById('mod-category').value = data.category;
                document.getElementById('mod-premium').value = data.is_premium.toString();
                
                document.getElementById('btn-save-module').innerText = "Simpan Perubahan";
                document.getElementById('btn-save-module').classList.remove('bg-purple-600');
                document.getElementById('btn-save-module').classList.add('bg-pink-600');
                document.getElementById('btn-cancel-module').classList.remove('hidden');

                document.getElementById('section-modules').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function cancelEditModule() {
            editingModuleId = null;
            document.getElementById('mod-title').value = '';
            document.getElementById('mod-link').value = '';
            document.getElementById('btn-save-module').innerText = "Upload Materi";
            document.getElementById('btn-save-module').classList.add('bg-purple-600');
            document.getElementById('btn-save-module').classList.remove('bg-pink-600');
            document.getElementById('btn-cancel-module').classList.add('hidden');
        }

        async function delModule(id) { 
            if((await Swal.fire({title:'Hapus Materi?', icon:'warning', showCancelButton:true})).isConfirmed) {
                await supabaseClient.from('modules').delete().eq('id', id); 
                fetchModules(); 
                Toast.fire({ icon: 'success', title: 'Materi Dihapus' }); 
            }
        }

        async function updateOrder(container, table) { const items = Array.from(container.children); for (let i = 0; i < items.length; i++) { await supabaseClient.from(table).update({ order_index: i }).eq('id', items[i].dataset.id); } }

        function initChart() { const ctx = document.getElementById('userChart'); if(ctx) { activityChart = new Chart(ctx.getContext('2d'), { type: 'bar', data: { labels: ['Home', 'Dashboard', 'Trip', 'Tiket'], datasets: [{ label: 'User Aktif', data: [0,0,0,0], backgroundColor: '#DB2777', borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } }); } }
        function initRealtimeDashboard() { const channel = supabaseClient.channel('online-users'); channel.on('presence', { event: 'sync' }, () => { const state = channel.presenceState(); let total = 0; let counts = {'Home':0, 'Dashboard':0, 'Trip':0, 'Tiket':0}; let html = ''; for (const id in state) { if(state[id][0].email) { total++; let p = state[id][0].page.replace('#',''); p = p.charAt(0).toUpperCase() + p.slice(1); if(counts[p] !== undefined) counts[p]++; html += `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-xl mb-1 border border-gray-100"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span class="text-xs font-bold text-gray-700">${state[id][0].email}</span></div><span class="text-[10px] text-gray-500 font-mono bg-white px-2 py-0.5 rounded border shadow-sm">${p}</span></div>`; } } document.getElementById('online-count').innerText = total + " Online"; document.getElementById('active-user-list').innerHTML = html || '<div class="text-center text-xs text-gray-400 py-4">Sepi...</div>'; if(activityChart) { activityChart.data.datasets[0].data = Object.values(counts); activityChart.update(); } }).subscribe(); }
        function setPreviewMode(mode) { const w = document.getElementById('preview-wrapper'); if(mode==='mobile') { w.style.width = '375px'; w.style.margin = '0 auto'; } else { w.style.width = '100%'; w.style.margin = '0'; } }
        function reloadPreview() { document.getElementById('preview-frame').contentWindow.location.reload(); Toast.fire({ icon: 'success', title: 'Preview Direfresh' }); }
        function exportToExcel() { const ws = XLSX.utils.json_to_sheet(allUsers); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, "Data_Peserta.xlsx"); Toast.fire({ icon: 'success', title: 'Download Excel dimulai' }); }
        async function logout() { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; }

        // Start Security Check Immediately
        checkAdmin();
    </script>
</body>
</html>
