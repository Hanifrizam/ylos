<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YLOS Admin Panel - Fixed System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // SETUP WORKER MANUAL (WAJIB)
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #F8FAFC; }
        
        /* Sidebar & Navigation */
        .sidebar-item { transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; margin-bottom: 4px; }
        .sidebar-item:hover { background-color: #FFF1F2; color: #BE185D; }
        .sidebar-item.active { background-color: #FFF1F2; color: #BE185D; border-left-color: #BE185D; font-weight: 700; }
        
        /* Tab Logic */
        .content-section { display: none !important; animation: fadeIn 0.3s ease-out; }
        .content-section.active { display: flex !important; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PDF & SIGNING AREA (FIXED) --- */
        #pdf-scroll-container {
            background-color: #374151; /* Dark Gray */
            padding: 40px;
            overflow: auto;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            position: relative;
        }

        #pdf-wrapper {
            position: relative; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            /* Pastikan wrapper membungkus canvas dengan ketat */
            display: inline-block; 
        }

        canvas#the-canvas {
            display: block;
            background-color: white;
        }

        /* DRAGGABLE SIGNATURE */
        .signature-box {
            position: absolute;
            width: 150px;
            height: 80px;
            border: 2px dashed #BE185D;
            background-color: rgba(255, 192, 203, 0.4);
            cursor: grab;
            z-index: 999;
            top: 50px; left: 50px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            /* Mencegah interaksi pointer dengan gambar agar drag lancar */
            user-select: none;
            touch-action: none;
        }
        
        .signature-box:active {
            cursor: grabbing;
            background-color: rgba(255, 133, 179, 0.6);
            border-color: #9D174D;
        }

        .signature-box img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none; /* KUNCI DRAG AND DROP */
        }

        /* FullCalendar Override */
        .fc-button-primary { background-color: #BE185D !important; border-color: #BE185D !important; }
        .fc-daygrid-event { background-color: #FCE7F3 !important; color: #9D174D !important; border-left: 3px solid #BE185D !important; }
        
        /* SweetAlert */
        div:where(.swal2-container) button:where(.swal2-styled).swal2-confirm { background-color: #BE185D !important; border-radius: 10px; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

    <aside class="w-72 bg-white border-r border-gray-100 hidden md:flex flex-col z-30 shadow-sm">
        <div class="h-20 flex items-center px-8 border-b border-gray-50">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-pink-200">Y</div>
                <div class="flex flex-col"><span class="text-lg font-extrabold text-gray-900 leading-none">YLOS</span><span class="text-[10px] font-bold text-pink-500 uppercase tracking-widest">Admin Panel</span></div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto py-6 px-4 space-y-1">
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 mt-1">Overview</p>
            <div onclick="switchTab('dashboard')" id="menu-dashboard" class="sidebar-item active px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard</div>
            <div onclick="switchTab('calendar')" id="menu-calendar" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-regular fa-calendar-days w-5 text-center"></i> Jadwal & Kalender</div>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 mt-6">Management</p>
            <div onclick="switchTab('digisign')" id="menu-digisign" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-file-signature w-5 text-center"></i> DigiSign E-Document</div>
            <div onclick="switchTab('users')" id="menu-users" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-users w-5 text-center"></i> Data Peserta</div>
            <div onclick="switchTab('verification')" id="menu-verification" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-envelope-circle-check w-5 text-center"></i> Verifikasi Email</div>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 mt-6">Content</p>
            <div onclick="switchTab('announcements')" id="menu-announcements" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-bullhorn w-5 text-center"></i> Pengumuman</div>
            <div onclick="switchTab('modules')" id="menu-modules" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-layer-group w-5 text-center"></i> Modul & Materi</div>
            <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 mt-6">System</p>
            <div onclick="switchTab('preview')" id="menu-preview" class="sidebar-item px-4 py-3 rounded-xl flex items-center gap-3 text-sm font-medium text-gray-600"><i class="fa-solid fa-mobile-screen-button w-5 text-center"></i> Live Preview</div>
        </div>
        <div class="p-5 border-t border-gray-50 bg-gray-50/50">
            <button onclick="window.location.href='index.html'" class="w-full mb-3 flex items-center justify-center gap-2 text-xs font-bold text-gray-500 hover:text-pink-600 py-2.5 rounded-xl border border-gray-200 bg-white hover:bg-gray-50 transition shadow-sm"><i class="fa-solid fa-arrow-up-right-from-square"></i> Buka Website</button>
            <button onclick="logout()" class="w-full bg-red-50 text-red-600 py-2.5 rounded-xl font-bold text-xs hover:bg-red-100 transition flex items-center justify-center gap-2"><i class="fa-solid fa-power-off"></i> Keluar</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-[#F8FAFC]">
        <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 md:hidden flex-shrink-0 z-40 shadow-sm">
            <span class="font-bold text-lg text-gray-800">YLOS Admin</span>
            <button onclick="logout()" class="text-red-500 p-2"><i class="fa-solid fa-power-off"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 lg:p-10 scroll-smooth">
            
            <div id="section-dashboard" class="content-section active space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div><h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">Dashboard Overview</h1><p class="text-gray-500 text-sm mt-1">Pantau aktivitas pendaftaran dan user secara realtime.</p></div>
                    <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-full border border-gray-200 shadow-sm"><span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span></span><span class="text-xs font-bold text-gray-600 uppercase">Live Database</span></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-5"><div class="w-14 h-14 rounded-2xl bg-blue-50 flex items-center justify-center text-blue-600 text-2xl"><i class="fa-solid fa-users"></i></div><div><p class="text-[10px] font-bold text-gray-400 uppercase">Total Peserta</p><h3 class="text-3xl font-extrabold text-gray-900" id="stat-total">0</h3></div></div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-5"><div class="w-14 h-14 rounded-2xl bg-green-50 flex items-center justify-center text-green-600 text-2xl"><i class="fa-solid fa-circle-check"></i></div><div><p class="text-[10px] font-bold text-gray-400 uppercase">Lunas</p><h3 class="text-3xl font-extrabold text-green-600" id="stat-lunas">0</h3></div></div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center gap-5"><div class="w-14 h-14 rounded-2xl bg-yellow-50 flex items-center justify-center text-yellow-600 text-2xl"><i class="fa-solid fa-clock"></i></div><div><p class="text-[10px] font-bold text-gray-400 uppercase">Pending</p><h3 class="text-3xl font-extrabold text-yellow-600" id="stat-pending">0</h3></div></div>
                </div>
            </div>

            <div id="section-calendar" class="content-section space-y-6">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] border border-gray-100"><div id="calendar" class="min-h-[700px]"></div></div>
            </div>

            <div id="section-digisign" class="content-section space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div><h2 class="text-2xl font-bold text-gray-900">DigiSign E-Document</h2><p class="text-gray-500 text-sm mt-1">Upload dokumen, minta tanda tangan admin lain.</p></div>
                    <button onclick="openUploadModal()" class="bg-gradient-to-r from-pink-600 to-rose-600 text-white px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-pink-200 hover:-translate-y-0.5 transition flex items-center gap-2"><i class="fa-solid fa-plus"></i> Upload Dokumen</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center"><div><p class="text-xs text-gray-400 font-bold uppercase">Perlu TTD Saya</p><h3 class="text-2xl font-bold text-pink-600" id="ds-need-sign">0</h3></div><i class="fa-solid fa-file-pen text-3xl text-pink-100"></i></div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center"><div><p class="text-xs text-gray-400 font-bold uppercase">Request Terkirim</p><h3 class="text-2xl font-bold text-blue-600" id="ds-sent">0</h3></div><i class="fa-solid fa-paper-plane text-3xl text-blue-100"></i></div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center"><div><p class="text-xs text-gray-400 font-bold uppercase">Selesai</p><h3 class="text-2xl font-bold text-green-600" id="ds-completed">0</h3></div><i class="fa-solid fa-file-circle-check text-3xl text-green-100"></i></div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-5 border-b border-gray-50 flex gap-4">
                        <button onclick="filterDigiSign('inbox')" id="tab-inbox" class="ds-tab active px-4 py-2 rounded-lg text-sm font-bold bg-pink-50 text-pink-700">Inbox</button>
                        <button onclick="filterDigiSign('sent')" id="tab-sent" class="ds-tab px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-50">Request Terkirim</button>
                        <button onclick="filterDigiSign('completed')" id="tab-completed" class="ds-tab px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:bg-gray-50">Arsip Selesai</button>
                    </div>
                    <table class="w-full text-left"><thead class="bg-gray-50 text-xs font-bold text-gray-400 uppercase"><tr><th class="px-6 py-4">Dokumen</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Info User</th><th class="px-6 py-4 text-center">Aksi</th></tr></thead><tbody id="digisign-list" class="divide-y divide-gray-50 text-sm font-medium text-gray-700"></tbody></table>
                </div>
            </div>

            <div id="signing-modal" class="fixed inset-0 bg-gray-900/95 z-[60] hidden flex flex-col">
                <div class="bg-white h-16 px-6 flex justify-between items-center border-b border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800">✍️ Signing Room</h3>
                    <div class="flex gap-3"><button onclick="closeSigningModal()" class="px-4 py-2 text-sm font-bold text-gray-600 hover:bg-gray-100 rounded-lg">Batal</button><button onclick="saveSignedDocument()" class="px-6 py-2 text-sm font-bold text-white bg-pink-600 hover:bg-pink-700 rounded-lg shadow-lg">Selesai & Simpan</button></div>
                </div>
                <div class="flex-1 flex overflow-hidden">
                    <div class="w-80 bg-gray-50 border-r border-gray-200 p-5 flex flex-col gap-6 flex-shrink-0">
                        <div class="bg-white p-4 rounded-xl border border-gray-200 text-center shadow-sm">
                            <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Gambar TTD Disini</p>
                            <div class="border border-gray-300 rounded-lg w-full h-32 bg-white relative">
                                <canvas id="signature-pad" class="w-full h-full cursor-crosshair touch-none"></canvas>
                            </div>
                            <div class="flex justify-between mt-3 px-1">
                                <button onclick="clearPad()" class="text-xs text-red-500 font-bold hover:text-red-700">Hapus</button>
                                <button onclick="useSignature()" class="text-xs text-white bg-blue-600 px-4 py-1.5 rounded-md font-bold hover:bg-blue-700 shadow-sm">Gunakan</button>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl text-xs text-blue-800 leading-relaxed border border-blue-100">
                            <strong class="block mb-2 text-sm"><i class="fa-solid fa-circle-info"></i> Petunjuk:</strong>
                            1. Tanda tangan di kotak putih.<br>
                            2. Klik tombol <b>"Gunakan"</b>.<br>
                            3. Kotak TTD akan muncul di area PDF.<br>
                            4. <b>GESER (Drag)</b> kotak ke posisi yang pas.
                        </div>
                    </div>
                    
                    <div id="pdf-scroll-container">
                        <div id="pdf-wrapper">
                            <canvas id="the-canvas"></canvas>
                            <div id="drag-signature" class="signature-box hidden">
                                <img id="drag-sig-img" src="" alt="TTD">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-users" class="content-section space-y-6"><div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h2 class="text-xl font-bold text-gray-900 pl-2">Database Peserta</h2><div class="flex gap-3 w-full md:w-auto"><div class="relative flex-1 md:w-72"><i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400 text-sm"></i><input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Cari nama..." class="w-full pl-11 pr-4 py-3 rounded-xl border border-gray-200 bg-gray-50 outline-none transition text-sm"></div><button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl text-sm font-bold shadow-lg transition">Export</button></div></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="bg-gray-50/80 text-gray-500 text-xs font-bold uppercase tracking-wider border-b border-gray-100"><tr><th class="px-6 py-4">Nama</th><th class="px-6 py-4">Sekolah</th><th class="px-6 py-4">Status</th><th class="px-6 py-4 text-center">Aksi</th></tr></thead><tbody id="userTableBody" class="divide-y divide-gray-50 text-sm"></tbody></table></div></div></div>
            <div id="section-announcements" class="content-section space-y-6"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-900">Kelola Pengumuman</h2></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Buat Baru</h3><div class="space-y-4"><input type="text" id="announce-title" placeholder="Judul" class="w-full p-4 bg-gray-50 border rounded-xl outline-none"><textarea id="announce-content" rows="2" placeholder="Detail..." class="w-full p-4 bg-gray-50 border rounded-xl outline-none"></textarea><div class="flex justify-end"><button onclick="addAnnouncement()" class="bg-pink-600 hover:bg-pink-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition">Posting</button></div></div></div><div id="announcement-list" class="space-y-3"></div></div>
            <div id="section-modules" class="content-section space-y-6"><div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-900">Kelola Modul</h2></div><div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5"><input type="text" id="mod-title" placeholder="Judul" class="w-full p-3 bg-gray-50 border rounded-xl outline-none"><input type="text" id="mod-link" placeholder="Link" class="w-full p-3 bg-gray-50 border rounded-xl outline-none"><select id="mod-category" class="w-full p-3 bg-gray-50 border rounded-xl outline-none"><option value="Guidebook">Guidebook</option><option value="Materi">Materi</option></select><select id="mod-premium" class="w-full p-3 bg-gray-50 border rounded-xl outline-none"><option value="false">Free</option><option value="true">Premium</option></select></div><button onclick="addModule()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-lg">Upload</button></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 text-xs font-bold text-gray-400 uppercase"><tr><th class="px-6 py-3 w-10">#</th><th class="px-6 py-3">Judul</th><th class="px-6 py-3">Kategori</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-center">Aksi</th></tr></thead><tbody id="module-list" class="divide-y divide-gray-50 text-sm"></tbody></table></div></div>
            <div id="section-verification" class="content-section space-y-6"><div class="bg-gradient-to-r from-orange-50 to-amber-50 p-6 rounded-2xl border border-orange-100 flex flex-col md:flex-row justify-between items-center gap-4"><div class="flex items-start gap-4"><div class="bg-white p-3 rounded-xl text-orange-600"><i class="fa-solid fa-triangle-exclamation text-xl"></i></div><div><h2 class="text-lg font-bold text-orange-900">Pusat Bantuan Verifikasi</h2><p class="text-orange-800/70 text-sm mt-1">Daftar pendaftar terbaru yang mungkin belum verifikasi.</p></div></div><button onclick="fetchUsers()" class="bg-white border border-orange-200 text-orange-700 px-5 py-3 rounded-xl text-sm font-bold hover:bg-orange-100 transition shadow-sm flex items-center gap-2"><i class="fa-solid fa-rotate-right"></i> Refresh</button></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"><table class="w-full text-left"><thead class="bg-gray-50 text-xs font-bold text-gray-500 uppercase"><tr><th class="px-6 py-4">Nama</th><th class="px-6 py-4">Email</th><th class="px-6 py-4">WA</th><th class="px-6 py-4 text-center">Aksi</th></tr></thead><tbody id="verification-list" class="divide-y divide-gray-50 text-sm"></tbody></table></div></div>
            <div id="section-preview" class="content-section h-full flex flex-col space-y-4" style="height: calc(100vh - 120px);"><div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-gray-200 shadow-sm flex-shrink-0"><h2 class="text-lg font-bold text-gray-800 flex items-center gap-2"><i class="fa-solid fa-mobile-screen-button text-pink-500"></i> Simulasi</h2><div class="flex items-center gap-3"><div class="bg-gray-100 p-1 rounded-xl flex"><button onclick="setPreviewMode('desktop')" id="btn-desktop" class="px-4 py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-gray-900 transition">Desktop</button><button onclick="setPreviewMode('mobile')" id="btn-mobile" class="px-4 py-2 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-900 transition">Mobile</button></div><button onclick="reloadPreview()" class="w-10 h-10 flex items-center justify-center bg-white border border-gray-200 rounded-xl text-gray-500 hover:text-pink-600 transition shadow-sm"><i class="fa-solid fa-rotate-right"></i></button></div></div><div class="flex-1 bg-gray-100 rounded-3xl p-8 border border-gray-200 shadow-inner overflow-hidden flex justify-center items-start"><div id="preview-wrapper" class="w-full h-full bg-white shadow-2xl rounded-2xl border-[8px] border-gray-800 overflow-hidden transition-all duration-300 relative"><iframe id="preview-frame" src="index.html?preview=true#dashboard" class="w-full h-full" frameborder="0"></iframe></div></div></div>
        </div>
    </main>

    <script>
        const supabaseClient = supabase.createClient(
            'https://jrslgkxwjvugvgakxwsd.supabase.co', 
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impyc2xna3h3anZ1Z3ZnYWt4d3NkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MTYyNDYsImV4cCI6MjA4NTM5MjI0Nn0.q2GGd0kdKt7KGWt7QpfeP0UUBOStmuUH51caPoCrmMk'
        );

        let allUsers = [], calendarInstance, signaturePad, currentDocId, pdfBytes;

        async function checkAdmin() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            fetchUsers(); fetchAnnouncements(); fetchModules(); initChart(); initCalendarRealtime();
            initDigiSignRealtime(); fetchDigiSignDocs();
        }

        // --- DIGISIGN LOGIC ---
        function initDigiSignRealtime() {
            supabaseClient.channel('digisign-updates').on('postgres_changes', { event: '*', schema: 'public', table: 'digisign_documents' }, () => {
                fetchDigiSignDocs(); updateDigiSignStats();
            }).subscribe();
        }

        async function fetchDigiSignDocs(filter = 'inbox') {
            document.querySelectorAll('.ds-tab').forEach(b => { b.classList.remove('active', 'bg-pink-50', 'text-pink-700'); b.classList.add('text-gray-500', 'hover:bg-gray-50'); });
            const activeTab = document.getElementById(`tab-${filter}`);
            if(activeTab) { activeTab.classList.add('active', 'bg-pink-50', 'text-pink-700'); activeTab.classList.remove('text-gray-500', 'hover:bg-gray-50'); }
            
            const { data: { user } } = await supabaseClient.auth.getUser();
            let query = supabaseClient.from('digisign_documents').select('*, requester:requester_id(full_name, email), signer:signer_id(full_name, email)');

            if(filter === 'inbox') query = query.eq('signer_id', user.id).eq('status', 'pending');
            else if(filter === 'sent') query = query.eq('requester_id', user.id);
            else if(filter === 'completed') query = query.eq('status', 'signed');

            const { data } = await query.order('created_at', {ascending: false});
            const tbody = document.getElementById('digisign-list');
            tbody.innerHTML = '';
            updateDigiSignStats();

            if(!data || data.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada dokumen.</td></tr>`; return; }

            data.forEach(doc => {
                let infoUser = filter === 'inbox' ? `<div class="text-xs text-gray-600"><b>Dari:</b> ${doc.requester?.full_name || 'Admin'}</div>` : `<div class="text-xs text-gray-600"><b>Kepada:</b> ${doc.signer?.full_name || 'Admin'}</div>`;
                let actionBtn = filter === 'inbox' ? `<button onclick="openSigningRoom('${doc.id}', '${doc.file_path}')" class="bg-pink-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-pink-700 shadow-sm">Tanda Tangani</button>` : (doc.status === 'signed' ? `<a href="${doc.signed_file_path}" target="_blank" class="text-green-600 font-bold text-xs hover:underline"><i class="fa-solid fa-download"></i> Download</a>` : `<span class="text-yellow-600 text-xs font-bold bg-yellow-50 px-2 py-1 rounded">Menunggu...</span>`);
                let statusBadge = doc.status === 'signed' ? `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-green-100 text-green-700">Signed</span>` : `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase bg-yellow-100 text-yellow-700">Pending</span>`;
                tbody.innerHTML += `<tr class="hover:bg-gray-50 border-b border-gray-50 transition"><td class="px-6 py-4 font-bold text-gray-800">${doc.filename}</td><td class="px-6 py-4">${statusBadge}</td><td class="px-6 py-4">${infoUser}</td><td class="px-6 py-4 text-center">${actionBtn}</td></tr>`;
            });
        }

        async function updateDigiSignStats() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { count: inbox } = await supabaseClient.from('digisign_documents').select('*', {count: 'exact', head: true}).eq('signer_id', user.id).eq('status', 'pending');
            const { count: sent } = await supabaseClient.from('digisign_documents').select('*', {count: 'exact', head: true}).eq('requester_id', user.id);
            const { count: done } = await supabaseClient.from('digisign_documents').select('*', {count: 'exact', head: true}).eq('status', 'signed');
            document.getElementById('ds-need-sign').innerText = inbox || 0;
            document.getElementById('ds-sent').innerText = sent || 0;
            document.getElementById('ds-completed').innerText = done || 0;
        }

        async function openUploadModal() {
            const { data: admins } = await supabaseClient.from('profiles').select('id, full_name, email').eq('role', 'admin');
            let options = admins.map(a => `<option value="${a.id}">${a.full_name} (${a.email})</option>`).join('');
            const { value: formValues } = await Swal.fire({ title: 'Upload Dokumen', html: `<input type="file" id="up-file" class="swal2-input" accept="application/pdf"><select id="up-signer" class="swal2-select">${options}</select>`, focusConfirm: false, showCancelButton: true, confirmButtonText: 'Upload', preConfirm: () => { const file = document.getElementById('up-file').files[0]; const signer = document.getElementById('up-signer').value; if(!file) Swal.showValidationMessage('Pilih file!'); return { file: file, signer: signer } } });
            if (formValues) {
                Swal.fire({title: 'Uploading...', didOpen: () => Swal.showLoading()});
                const { data: { user } } = await supabaseClient.auth.getUser();
                const fileName = `${Date.now()}_${formValues.file.name}`;
                const { error: uploadError } = await supabaseClient.storage.from('digisign-files').upload(fileName, formValues.file);
                if (uploadError) return Swal.fire('Error', uploadError.message, 'error');
                const { data: { publicUrl } } = supabaseClient.storage.from('digisign-files').getPublicUrl(fileName);
                await supabaseClient.from('digisign_documents').insert({ filename: formValues.file.name, file_path: publicUrl, signer_id: formValues.signer, requester_id: user.id });
                Swal.fire('Sukses', 'Terkirim!', 'success'); fetchDigiSignDocs();
            }
        }

        function filterDigiSign(type) { fetchDigiSignDocs(type); }

        // --- SIGNING ROOM: THE ARCHITECT FIX ---
        
        // HELPER: CLONE BUFFER (FIX DETACHED ERROR)
        function cloneBuffer(buffer) {
            const dst = new ArrayBuffer(buffer.byteLength);
            new Uint8Array(dst).set(new Uint8Array(buffer));
            return dst;
        }

        async function openSigningRoom(docId, fileUrl) {
            currentDocId = docId; document.getElementById('signing-modal').classList.remove('hidden');
            Swal.fire({title: 'Memuat PDF...', didOpen: () => Swal.showLoading(), backdrop: false, showConfirmButton: false});
            
            // DELAY UNTUK DOM READY
            await new Promise(r => setTimeout(r, 500));
            
            try {
                // 1. INIT SIGNATURE PAD
                const sigCanvas = document.getElementById('signature-pad');
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                sigCanvas.width = sigCanvas.offsetWidth * ratio;
                sigCanvas.height = sigCanvas.offsetHeight * ratio;
                sigCanvas.getContext("2d").scale(ratio, ratio);
                
                // SAFETY CHECK BEFORE CLEAR
                if(signaturePad) signaturePad.off(); 
                signaturePad = new SignaturePad(sigCanvas);
                signaturePad.clear();

                // 2. FETCH PDF ARRAYBUFFER (FIXED)
                const response = await fetch(fileUrl);
                if (!response.ok) throw new Error("Gagal download PDF (CORS/Network)");
                const arrayBuffer = await response.arrayBuffer();
                pdfBytes = arrayBuffer; // Simpan Original

                // 3. RENDER PDF (USE CLONED BUFFER)
                // Kita gunakan data.slice(0) untuk membuat salinan baru khusus viewer
                const viewerData = cloneBuffer(pdfBytes);
                const loadingTask = pdfjsLib.getDocument({data: viewerData});
                
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                
                const canvas = document.getElementById('the-canvas');
                const context = canvas.getContext('2d');
                const viewport = page.getViewport({scale: 1.2});
                canvas.height = viewport.height; 
                canvas.width = viewport.width;
                
                await page.render({canvasContext: context, viewport: viewport}).promise;
                
                // 4. RESET DRAG ELEMENT
                const dragEl = document.getElementById('drag-signature');
                dragEl.classList.add('hidden');
                dragEl.style.top = '50px'; 
                dragEl.style.left = '50px';
                
                initDraggable(dragEl); // Attach Listener
                
                Swal.close();
            } catch (err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Memuat PDF',
                    text: err.message,
                    footer: '<small>Cek CORS di Supabase Storage</small>'
                });
            }
        }

        function closeSigningModal() { document.getElementById('signing-modal').classList.add('hidden'); if(signaturePad) signaturePad.clear(); }
        function clearPad() { if(signaturePad) signaturePad.clear(); }
        function useSignature() { 
            if (signaturePad && signaturePad.isEmpty()) return Swal.fire('Error', 'Tanda tangan dulu!', 'warning'); 
            const img = document.getElementById('drag-sig-img'); 
            img.src = signaturePad.toDataURL(); 
            document.getElementById('drag-signature').classList.remove('hidden'); 
        }

        // --- NEW DRAG LOGIC (MOUSE ABSOLUTE) ---
        function initDraggable(element) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            element.onmousedown = function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = element.offsetLeft;
                initialTop = element.offsetTop;
                element.style.cursor = 'grabbing';
            };

            window.onmousemove = function(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                element.style.left = `${initialLeft + dx}px`;
                element.style.top = `${initialTop + dy}px`;
            };

            window.onmouseup = function() {
                isDragging = false;
                element.style.cursor = 'grab';
            };
        }

        async function saveSignedDocument() {
            const dragEl = document.getElementById('drag-signature');
            if(dragEl.classList.contains('hidden')) return Swal.fire('Error', 'Letakkan TTD dulu!', 'error');
            Swal.fire({title: 'Menyimpan...', didOpen: () => Swal.showLoading()});
            try {
                // LOAD PDF DARI CLONED BUFFER (AGAR TIDAK DETACHED)
                const pdfDoc = await PDFLib.PDFDocument.load(cloneBuffer(pdfBytes));
                
                const firstPage = pdfDoc.getPages()[0];
                const sigImage = await pdfDoc.embedPng(signaturePad.toDataURL());
                
                const canvas = document.getElementById('the-canvas');
                const pdfWidth = firstPage.getWidth();
                const pdfHeight = firstPage.getHeight();
                
                const scaleX = pdfWidth / canvas.width;
                const scaleY = pdfHeight / canvas.height;
                
                const htmlX = dragEl.offsetLeft;
                const htmlY = dragEl.offsetTop;
                const imgWidth = 150; 
                const imgHeight = 80; 

                const x = htmlX * scaleX;
                const y = pdfHeight - (htmlY * scaleY) - imgHeight;

                firstPage.drawImage(sigImage, { x: x, y: y, width: imgWidth, height: imgHeight });
                
                const pdfBytesSigned = await pdfDoc.save();
                const signedFile = new File([new Blob([pdfBytesSigned], { type: 'application/pdf' })], `signed_${Date.now()}.pdf`, { type: 'application/pdf' });
                
                const { error: uploadError } = await supabaseClient.storage.from('digisign-files').upload(`signed/${signedFile.name}`, signedFile);
                if(uploadError) throw uploadError;
                const { data: { publicUrl } } = supabaseClient.storage.from('digisign-files').getPublicUrl(`signed/${signedFile.name}`);
                
                await supabaseClient.from('digisign_documents').update({ status: 'signed', signed_file_path: publicUrl, signed_at: new Date() }).eq('id', currentDocId);
                closeSigningModal(); fetchDigiSignDocs(); Swal.fire('Sukses!', 'Dokumen ditandatangani.', 'success');
            } catch (err) { console.error(err); Swal.fire('Gagal', err.message, 'error'); }
        }

        // --- TAB & BASIC ---
        function switchTab(tabId) { document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active')); document.getElementById('section-' + tabId).classList.add('active'); document.getElementById('menu-' + tabId).classList.add('active'); if (tabId === 'calendar') setTimeout(() => { !calendarInstance ? initCalendar() : calendarInstance.render(); }, 100); }
        function initCalendar() { const calendarEl = document.getElementById('calendar'); calendarInstance = new FullCalendar.Calendar(calendarEl, { initialView: 'dayGridMonth', headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' }, locale: 'id', editable: true, selectable: true, events: async function(info, successCallback, failureCallback) { const { data, error } = await supabaseClient.from('admin_calendar').select('*'); if (error) { failureCallback(error); return; } successCallback(data.map(evt => ({ id: evt.id, title: evt.title, start: evt.start_time, end: evt.end_time, description: evt.description, allDay: !evt.end_time }))); }, select: async function(info) { const { value: formValues } = await Swal.fire({ title: 'Tambah Jadwal', html: `<input id="cal-title" class="swal2-input" placeholder="Nama Kegiatan"><textarea id="cal-desc" class="swal2-textarea" placeholder="Deskripsi"></textarea><input id="cal-start" type="datetime-local" class="swal2-input" value="${info.startStr}T09:00"><input id="cal-end" type="datetime-local" class="swal2-input">`, focusConfirm: false, showCancelButton: true, confirmButtonText: 'Simpan', preConfirm: () => { return { title: document.getElementById('cal-title').value, description: document.getElementById('cal-desc').value, start: document.getElementById('cal-start').value, end: document.getElementById('cal-end').value || null } } }); if (formValues && formValues.title) { await supabaseClient.from('admin_calendar').insert({ title: formValues.title, description: formValues.description, start_time: formValues.start, end_time: formValues.end }); calendarInstance.refetchEvents(); } }, eventClick: async function(info) { const evt = info.event; const { isDenied } = await Swal.fire({ title: evt.title, showDenyButton: true, showCancelButton: true, confirmButtonText: 'Tutup', denyButtonText: 'Hapus' }); if (isDenied) { await supabaseClient.from('admin_calendar').delete().eq('id', evt.id); evt.remove(); } }, eventDrop: async function(info) { await supabaseClient.from('admin_calendar').update({ start_time: info.event.start.toISOString(), end_time: info.event.end ? info.event.end.toISOString() : null }).eq('id', info.event.id); } }); calendarInstance.render(); }
        function initCalendarRealtime() { supabaseClient.channel('calendar-sync').on('postgres_changes', { event: '*', schema: 'public', table: 'admin_calendar' }, payload => { if(calendarInstance) calendarInstance.refetchEvents(); }).subscribe(); }
        function initChart() { const ctx = document.getElementById('userChart'); if(ctx) { activityChart = new Chart(ctx.getContext('2d'), { type: 'bar', data: { labels: ['Home', 'Dashboard', 'Trip', 'Tiket'], datasets: [{ label: 'User Aktif', data: [0,0,0,0], backgroundColor: '#FF85B3' }] }, options: { responsive: true, maintainAspectRatio: false } }); } }
        function initRealtimeDashboard() { const channel = supabaseClient.channel('online-users'); channel.on('presence', { event: 'sync' }, () => { const state = channel.presenceState(); let counts = { 'Home': 0, 'Dashboard': 0, 'Trip': 0, 'Tiket': 0 }; let total = 0; let html = ''; for (const id in state) { const u = state[id][0]; if(u.email) { total++; let p = u.page.replace('#',''); p = p.charAt(0).toUpperCase() + p.slice(1); if(counts[p] !== undefined) counts[p]++; html += `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100 mb-2"><div class="flex items-center gap-3"><div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><div><p class="text-xs font-bold text-gray-900">${u.email}</p><p class="text-[10px] text-gray-500">${p}</p></div></div></div>`; } } document.getElementById('online-count').innerText = total + " Active"; document.getElementById('active-user-list').innerHTML = html || `<div class="text-center py-10 text-gray-400">Sepi...</div>`; if(activityChart) { activityChart.data.datasets[0].data = Object.values(counts); activityChart.update(); } }).subscribe(); }
        function setPreviewMode(m) { const w=document.getElementById('preview-wrapper'); if(m==='mobile') { w.classList.remove('w-full'); w.classList.add('w-[375px]'); } else { w.classList.remove('w-[375px]'); w.classList.add('w-full'); } }
        function reloadPreview() { document.getElementById('preview-frame').contentWindow.location.reload(); }
        function exportToExcel() { const ws=XLSX.utils.json_to_sheet(allUsers); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"Data_Peserta.xlsx"); }
        async function logout() { await supabaseClient.auth.signOut(); window.location.href='index.html'; }

        checkAdmin();
    </script>
</body>
</html>
